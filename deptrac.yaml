# Deptrac Configuration for HotOnes
# Architecture validation to prevent circular dependencies and enforce layering
deptrac:
  # Paths to analyze
  paths:
    - ./src

  # Files to exclude
  exclude_files:
    - '#.*Test\.php$#'
    - '#.*Kernel\.php$#'
    - '#.*Component\.php$#'
    - '#src/Scheduler/.*\.php$#'  # Deptrac parser issues with PHP 8.4 syntax

  # Define architectural layers
  layers:
    # Presentation Layer
    - name: Controller
      collectors:
        - type: directory
          value: src/Controller/.*

    # Application Layer
    - name: Service
      collectors:
        - type: directory
          value: src/Service/.*

    - name: Command
      collectors:
        - type: directory
          value: src/Command/.*

    - name: Form
      collectors:
        - type: directory
          value: src/Form/.*

    - name: EventListener
      collectors:
        - type: directory
          value: src/EventListener/.*

    - name: MessageHandler
      collectors:
        - type: directory
          value: src/MessageHandler/.*

    - name: Message
      collectors:
        - type: directory
          value: src/Message/.*

    # Domain Layer
    - name: Entity
      collectors:
        - type: directory
          value: src/Entity/.*

    - name: Repository
      collectors:
        - type: directory
          value: src/Repository/.*

    - name: Enum
      collectors:
        - type: directory
          value: src/Enum/.*

    - name: Factory
      collectors:
        - type: directory
          value: src/Factory/.*

    # Infrastructure Layer
    - name: Security
      collectors:
        - type: directory
          value: src/Security/.*

    - name: Scheduler
      collectors:
        - type: directory
          value: src/Scheduler/.*

  # Define allowed dependencies between layers
  ruleset:
    # Controllers can depend on:
    Controller:
      - Service
      - Form
      - Entity
      - Repository
      - Security
      - Enum
      - Message

    # Services can depend on:
    Service:
      - Entity
      - Repository
      - Factory
      - Enum
      - Message
      - Security

    # Commands can depend on:
    Command:
      - Service
      - Entity
      - Repository
      - Enum
      - Message

    # Forms can depend on:
    Form:
      - Entity
      - Enum
      - Repository

    # Event Listeners can depend on:
    EventListener:
      - Service
      - Entity
      - Repository
      - Enum
      - Message

    # Message Handlers can depend on:
    MessageHandler:
      - Service
      - Entity
      - Repository
      - Message
      - Enum

    # Messages can depend on:
    Message:
      - Entity
      - Enum

    # Entities can depend on:
    Entity:
      - Enum

    # Repositories can depend on:
    Repository:
      - Entity
      - Enum

    # Enums are leaf nodes (no dependencies)
    Enum: []

    # Factories can depend on:
    Factory:
      - Entity
      - Enum

    # Security can depend on:
    Security:
      - Entity
      - Repository
      - Service
      - Enum

    # Scheduler can depend on:
    Scheduler:
      - Service
      - Message
      - Entity
      - Repository
      - Enum

  # Skip violations (if needed)
  skip_violations:
    # Doctrine ORM entities reference their repository classes via attributes
    # This is metadata, not actual code dependency, so we skip it
    App\Entity\AccountDeletionRequest:
      - App\Repository\AccountDeletionRequestRepository
    App\Entity\Achievement:
      - App\Repository\AchievementRepository
    App\Entity\Analytics\FactStaffingMetrics:
      - App\Repository\StaffingMetricsRepository
    App\Entity\Badge:
      - App\Repository\BadgeRepository
    App\Entity\BillingMarker:
      - App\Repository\BillingMarkerRepository
    App\Entity\Client:
      - App\Repository\ClientRepository
    App\Entity\ClientContact:
      - App\Repository\ClientContactRepository
    App\Entity\CompanySettings:
      - App\Repository\CompanySettingsRepository
    App\Entity\Contributor:
      - App\Repository\ContributorRepository
    App\Entity\ContributorProgress:
      - App\Repository\ContributorProgressRepository
    App\Entity\ContributorSatisfaction:
      - App\Repository\ContributorSatisfactionRepository
    App\Entity\ContributorSkill:
      - App\Repository\ContributorSkillRepository
    App\Entity\CookieConsent:
      - App\Repository\CookieConsentRepository
    App\Entity\EmploymentPeriod:
      - App\Repository\EmploymentPeriodRepository
    App\Entity\ExpenseReport:
      - App\Repository\ExpenseReportRepository
    App\Entity\FactForecast:
      - App\Repository\FactForecastRepository
    App\Entity\Invoice:
      - App\Repository\InvoiceRepository
    App\Entity\LeadCapture:
      - App\Repository\LeadCaptureRepository
    App\Entity\Notification:
      - App\Repository\NotificationRepository
    App\Entity\NotificationPreference:
      - App\Repository\NotificationPreferenceRepository
    App\Entity\NotificationSetting:
      - App\Repository\NotificationSettingRepository
    App\Entity\NpsSurvey:
      - App\Repository\NpsSurveyRepository
    App\Entity\OnboardingTask:
      - App\Repository\OnboardingTaskRepository
    App\Entity\OnboardingTemplate:
      - App\Repository\OnboardingTemplateRepository
    App\Entity\PerformanceReview:
      - App\Repository\PerformanceReviewRepository
    App\Entity\Order:
      - App\Repository\OrderRepository
    App\Entity\Planning:
      - App\Repository\PlanningRepository
    App\Entity\Profile:
      - App\Repository\ProfileRepository
    App\Entity\Project:
      - App\Repository\ProjectRepository
    App\Entity\ProjectEvent:
      - App\Repository\ProjectEventRepository
    App\Entity\ProjectHealthScore:
      - App\Repository\ProjectHealthScoreRepository
    App\Entity\ProjectSubTask:
      - App\Repository\ProjectSubTaskRepository
    App\Entity\ProjectTask:
      - App\Repository\ProjectTaskRepository
    App\Entity\Provider:
      - App\Repository\ProviderRepository
    App\Entity\RunningTimer:
      - App\Repository\RunningTimerRepository
    App\Entity\SaasProvider:
      - App\Repository\SaasProviderRepository
    App\Entity\SaasService:
      - App\Repository\SaasServiceRepository
    App\Entity\SaasSubscription:
      - App\Repository\SaasSubscriptionRepository
    App\Entity\Skill:
      - App\Repository\SkillRepository
    App\Entity\Subscription:
      - App\Repository\SubscriptionRepository
    App\Entity\Timesheet:
      - App\Repository\TimesheetRepository
    App\Entity\Vacation:
      - App\Repository\VacationRepository
    App\Entity\Vendor:
      - App\Repository\VendorRepository
    App\Entity\XpHistory:
      - App\Repository\XpHistoryRepository

  # Format options
  formatters:
    graphviz:
      groups:
        presentation:
          - Controller
          - Form
        application:
          - Service
          - Command
          - EventListener
          - MessageHandler
          - Message
        domain:
          - Entity
          - Repository
          - Enum
          - Factory
        infrastructure:
          - Security
          - Scheduler
