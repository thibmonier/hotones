{% extends 'layouts/base.html.twig' %}

{% block title %}Planning{% endblock %}

{% block stylesheets %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
<link href="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.10/index.global.min.css" rel="stylesheet">
<style>
  #calendar {
    max-width: 100%;
    margin: 0 auto;
  }
  .fc-resource-timeline .fc-scrollgrid-sync-table {
    width: 100% !important;
  }
  /* Custom event colors */
  .fc-event.status-planned { background-color: #3b82f6; border-color: #2563eb; }
  .fc-event.status-confirmed { background-color: #22c55e; border-color: #16a34a; }
  .fc-event.status-cancelled { background-color: #9ca3af; border-color: #6b7280; text-decoration: line-through; }
  .fc-event.event-vacation {
    background-color: #374151 !important;
    border-color: #1f2937 !important;
    color: #d1d5db !important;
    opacity: 0.8 !important;
    cursor: not-allowed !important;
    background-image: repeating-linear-gradient(
      45deg,
      transparent,
      transparent 10px,
      rgba(0, 0, 0, 0.1) 10px,
      rgba(0, 0, 0, 0.1) 20px
    );
  }
  .fc-event.readonly { opacity: 0.6; cursor: not-allowed; }
  /* Staffing info in resource labels */
  .staffing-info { font-size: 10px; color: #6b7280; margin-top: 2px; }
  .staffing-badge { display: inline-block; padding: 1px 4px; margin: 0 2px; border-radius: 2px; background: #f3f4f6; font-size: 9px; }
  .staffing-badge.high { background: #dcfce7; color: #166534; }
  .staffing-badge.overload { background: #fee2e2; color: #991b1b; }

  /* Choices.js custom styles for planning page */
  .choices__list--dropdown {
    background-color: #fff !important;
    border: 1px solid #dee2e6 !important;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    z-index: 9999 !important;
  }
  .choices__list--dropdown .choices__item {
    background-color: #fff !important;
    color: #212529 !important;
  }
  .choices__list--dropdown .choices__item--selectable.is-highlighted {
    background-color: #556ee6 !important;
    color: #fff !important;
  }
  .choices[data-type*="select-multiple"] .choices__inner {
    background-color: #fff !important;
    min-height: 38px !important;
  }
  .choices__inner {
    background-color: #fff !important;
    border: 1px solid #ced4da !important;
    border-radius: 0.25rem !important;
  }
</style>
{% endblock %}

{% block content %}
<div class="page-title-box d-flex align-items-center justify-content-between">
  <h4 class="mb-0">Planning</h4>
  <div class="w-100">
    {% if tace_analysis is not null %}
      {% set criticalCount = tace_analysis.critical|length %}
      {% set overloadedCount = tace_analysis.overloaded|length %}
      {% set totalIssues = criticalCount + overloadedCount %}
      {% if totalIssues > 0 %}
      <div class="alert alert-warning alert-dismissible fade show mb-3" role="alert">
        <i class="bx bx-error-circle me-2"></i>
        <strong>Attention !</strong> {{ totalIssues }} contributeur(s) en situation critique ou surchargé(s).
        {% if criticalCount > 0 %}
          <span class="badge bg-danger">{{ criticalCount }} critique{{ criticalCount > 1 ? 's' : '' }}</span>
        {% endif %}
        {% if overloadedCount > 0 %}
          <span class="badge bg-warning">{{ overloadedCount }} surchargé{{ overloadedCount > 1 ? 's' : '' }}</span>
        {% endif %}
        <a href="{{ path('planning_optimization_index') }}" class="alert-link ms-2">Voir les recommandations d'optimisation</a>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
      {% endif %}
    {% endif %}
    <form method="get" class="row g-2 align-items-end">
      <div class="col-auto">
        <label class="form-label">Début</label>
        <input type="date" name="start" value="{{ timeline_start|date('Y-m-d') }}" class="form-control" style="width: 180px;">
      </div>
      <div class="col-auto">
        <label class="form-label">Semaines</label>
        <select name="weeks" class="form-select" style="width: 120px;">
          {% for w in [4,8,12,16] %}
            <option value="{{ w }}" {% if w == app.request.get('weeks')|default(8) %}selected{% endif %}>{{ w }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto">
        <label class="form-label">Contributeurs</label>
        <select name="contributors[]" id="contributorsFilter" class="form-select planning-multiselect" multiple data-placeholder="Tous les contributeurs">
          {% for c in all_contributors %}
            <option value="{{ c.id }}" {% if (c.id ~ '') in selected_contributors %}selected{% endif %}>{{ c.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto">
        <label class="form-label">Chefs de projet</label>
        <select name="project_managers[]" id="projectManagersFilter" class="form-select planning-multiselect" multiple data-placeholder="Tous les chefs de projet">
          {% for u in all_project_managers %}
            <option value="{{ u.id }}" {% if (u.id ~ '') in selected_project_managers %}selected{% endif %}>{{ u.fullName ?? (u.firstName ~ ' ' ~ u.lastName) }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto">
        <label class="form-label">Projets</label>
        <select name="projects[]" id="projectsFilter" class="form-select planning-multiselect" multiple data-placeholder="Tous les projets">
          {% for p in all_projects %}
            <option value="{{ p.id }}" {% if (p.id ~ '') in selected_projects %}selected{% endif %}>{{ p.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto">
        <label class="form-label">Type de projet</label>
        <select name="project_types[]" id="projectTypesFilter" class="form-select planning-multiselect" multiple data-placeholder="Tous les types">
          {% for key,label in project_types %}
            <option value="{{ key }}" {% if key in selected_project_types %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto">
        <button class="btn btn-primary">Filtrer</button>
        <a class="btn btn-light" href="{{ path('planning_index') }}">Réinitialiser</a>
      </div>
    </form>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <div id="calendar"></div>
  </div>
</div>

<!-- Edit modal -->
<div class="modal fade" id="planEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Modifier la planification</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="planEditForm">
          <input type="hidden" name="planningId">
          <div class="mb-3">
            <label class="form-label">Début</label>
            <input type="date" name="startDate" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Fin</label>
            <input type="date" name="endDate" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Heures par jour</label>
            <input type="number" step="0.25" min="0" max="12" name="dailyHours" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Statut</label>
            <select name="status" class="form-select">
              <option value="planned">Planifié</option>
              <option value="confirmed">Confirmé</option>
              <option value="cancelled">Annulé</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea name="notes" class="form-control" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Diviser la tâche à cette date</label>
            <input type="date" name="splitDate" class="form-control">
            <small class="text-muted">La tâche sera divisée en 2 parties : avant et à partir de cette date</small>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Fermer</button>
        <button type="button" class="btn btn-warning" id="planSplit">Diviser</button>
        <button type="button" class="btn btn-primary" id="planEditSave">Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<!-- Create modal -->
<div class="modal fade" id="planCreateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Créer une planification</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="planCreateForm">
          <input type="hidden" name="contributorId">
          <div class="mb-3">
            <label class="form-label">Projet</label>
            <select name="projectId" class="form-select" required>
              <option value="">Sélectionner un projet...</option>
              {% for p in all_projects %}
                <option value="{{ p.id }}">{{ p.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Début</label>
            <input type="date" name="startDate" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Fin</label>
            <input type="date" name="endDate" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Heures par jour</label>
            <input type="number" step="0.25" min="0" max="12" name="dailyHours" class="form-control" value="7">
          </div>
          <div class="mb-3">
            <label class="form-label">Statut</label>
            <select name="status" class="form-select">
              <option value="planned">Planifié</option>
              <option value="confirmed">Confirmé</option>
              <option value="cancelled">Annulé</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea name="notes" class="form-control" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary" id="planCreateSave">Créer</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.10/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/locales/fr.global.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize Choices.js for all multi-select filters
  document.querySelectorAll('.planning-multiselect').forEach(function(select) {
    new Choices(select, {
      removeItemButton: true,
      placeholder: true,
      placeholderValue: select.getAttribute('data-placeholder'),
      searchPlaceholderValue: 'Rechercher...',
      noResultsText: 'Aucun résultat trouvé',
      noChoicesText: 'Aucun choix disponible',
      itemSelectText: 'Cliquer pour sélectionner',
    });
  });

  const calendarEl = document.getElementById('calendar');

  // Prepare resources (contributors) - one line per contributor
  const resources = [
    {% for g in groups %}
    {
      id: 'contributor-{{ g.contributor.id }}',
      title: '{{ g.contributor.name|e('js') }}',
      extendedProps: {
        contributorId: {{ g.contributor.id }},
        dailyHours: {{ contributor_daily_hours[g.contributor.id] ?? 7.0 }},
        staffing: {{ weekly_staffing[g.contributor.id]|default({})|json_encode|raw }}
      }
    },
    {% endfor %}
  ];

  // Prepare events (plannings + vacations)
  const events = [
    {% for g in groups %}
      {% for prj in g.projectRows %}
        {% for p in prj.items %}
          {% set weekEnd = p.endDate|date_modify('Sunday this week') %}
          {% set isReadonly = weekEnd < date('now') %}
        {
          id: 'planning-{{ p.id }}',
          resourceId: 'contributor-{{ g.contributor.id }}',
          title: '{{ prj.project.name|e('js') }} ({{ p.dailyHours }}h/j)',
          start: '{{ p.startDate|date('Y-m-d') }}',
          end: '{{ p.endDate|date_modify('+1 day')|date('Y-m-d') }}',
          classNames: ['status-{{ p.status }}', '{{ isReadonly ? "readonly" : "" }}'],
          editable: {{ isReadonly ? 'false' : 'true' }},
          extendedProps: {
            type: 'planning',
            planningId: {{ p.id }},
            projectName: '{{ prj.project.name|e('js') }}',
            dailyHours: {{ p.dailyHours }},
            status: '{{ p.status }}',
            notes: '{{ p.notes|default('')|e('js') }}',
            readonly: {{ isReadonly ? 'true' : 'false' }},
            csrfMove: '{{ csrf_token('move_planning_' ~ p.id) }}',
            csrfEdit: '{{ csrf_token('edit_planning_' ~ p.id) }}',
            csrfSplit: '{{ csrf_token('split_planning_' ~ p.id) }}'
          }
        },
        {% endfor %}
      {% endfor %}
      {% if vacations_by_contributor[g.contributor.id] is defined %}
        {% for v in vacations_by_contributor[g.contributor.id] %}
        {
          id: 'vacation-{{ v.id }}',
          resourceId: 'contributor-{{ g.contributor.id }}',
          title: '{{ v.typeLabel|e('js') }}',
          start: '{{ v.startDate|date('Y-m-d') }}',
          end: '{{ v.endDate|date_modify('+1 day')|date('Y-m-d') }}',
          classNames: ['event-vacation'],
          editable: false,
          extendedProps: {
            type: 'vacation'
          }
        },
        {% endfor %}
      {% endif %}
    {% endfor %}
  ];

  const calendar = new FullCalendar.Calendar(calendarEl, {
    schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
    locale: 'fr',
    initialView: 'resourceTimelineMonth',
    initialDate: '{{ timeline_start|date('Y-m-d') }}',
    aspectRatio: 2.5,
    headerToolbar: {
      left: 'today prev,next',
      center: 'title',
      right: 'resourceTimelineDay,resourceTimelineWeek,resourceTimelineMonth'
    },
    editable: true,
    selectable: true,
    resourceAreaHeaderContent: 'Contributeurs',
    resourceAreaWidth: '250px',
    resources: resources,
    events: events,
    resourceOrder: 'title',
    slotMinWidth: 50,
    height: 'auto',
    select: function(info) {
      // Open create modal
      const form = document.getElementById('planCreateForm');
      // Extract contributor ID from 'contributor-123' format
      const contributorId = info.resource.extendedProps.contributorId;
      form.contributorId.value = contributorId;

      // FullCalendar uses exclusive end dates, so subtract 1 day
      const startDate = new Date(info.start);
      const endDate = new Date(info.end);
      endDate.setDate(endDate.getDate() - 1); // Subtract 1 day

      // Format dates in local timezone
      form.startDate.value = startDate.toISOString().split('T')[0];
      form.endDate.value = endDate.toISOString().split('T')[0];

      // Ensure end date is not before start date
      if (form.endDate.value < form.startDate.value) {
        form.endDate.value = form.startDate.value;
      }

      form.projectId.value = '';
      form.dailyHours.value = '7';
      form.status.value = 'planned';
      form.notes.value = '';

      const modal = new bootstrap.Modal(document.getElementById('planCreateModal'));
      modal.show();

      calendar.unselect();
    },
    resourceLabelContent: function(arg) {
      const staffing = arg.resource.extendedProps.staffing;
      let html = '<div><strong>' + arg.resource.title + '</strong>';
      if (staffing && Object.keys(staffing).length > 0) {
        html += '<div class="staffing-info">';
        for (let week in staffing) {
          if (week.endsWith('_h')) continue;
          const pct = Math.round(staffing[week]);
          const cls = pct > 100 ? 'overload' : (pct >= 80 ? 'high' : '');
          html += '<span class="staffing-badge ' + cls + '">S' + week.split('-')[1] + ': ' + pct + '%</span>';
        }
        html += '</div>';
      }
      html += '</div>';
      return { html: html };
    },
    eventClick: function(info) {
      if (info.event.extendedProps.type === 'vacation') return;
      if (info.event.extendedProps.readonly) return;

      // Open edit modal
      const form = document.getElementById('planEditForm');
      form.planningId.value = info.event.extendedProps.planningId;
      form.startDate.value = info.event.start.toISOString().split('T')[0];
      form.endDate.value = new Date(info.event.end.getTime() - 86400000).toISOString().split('T')[0];
      form.dailyHours.value = info.event.extendedProps.dailyHours;
      form.status.value = info.event.extendedProps.status;
      form.notes.value = info.event.extendedProps.notes;

      const modal = new bootstrap.Modal(document.getElementById('planEditModal'));
      modal.show();

      // Store event ref for later
      window.currentEvent = info.event;
    },
    eventDrop: async function(info) {
      if (info.event.extendedProps.readonly) {
        info.revert();
        return;
      }

      // Call move endpoint
      try {
        const res = await fetch('/planning/' + info.event.extendedProps.planningId + '/move', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            _token: info.event.extendedProps.csrfMove,
            targetDate: info.event.start.toISOString().split('T')[0]
          })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Move failed');
      } catch (err) {
        alert(err.message);
        info.revert();
      }
    },
    eventResize: async function(info) {
      if (info.event.extendedProps.readonly) {
        info.revert();
        return;
      }

      // Call update endpoint
      try {
        const res = await fetch('/planning/' + info.event.extendedProps.planningId + '/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            _token: info.event.extendedProps.csrfEdit,
            startDate: info.event.start.toISOString().split('T')[0],
            endDate: new Date(info.event.end.getTime() - 86400000).toISOString().split('T')[0]
          })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Update failed');
      } catch (err) {
        alert(err.message);
        info.revert();
      }
    }
  });

  calendar.render();

  // Edit modal save button
  document.getElementById('planEditSave').addEventListener('click', async function() {
    const form = document.getElementById('planEditForm');
    const event = window.currentEvent;
    if (!event) return;

    try {
      const res = await fetch('/planning/' + form.planningId.value + '/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          _token: event.extendedProps.csrfEdit,
          startDate: form.startDate.value,
          endDate: form.endDate.value,
          dailyHours: form.dailyHours.value,
          status: form.status.value,
          notes: form.notes.value
        })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Update failed');

      // Reload page to refresh
      location.reload();
    } catch (err) {
      alert(err.message);
    }
  });

  // Split button
  document.getElementById('planSplit').addEventListener('click', async function() {
    const form = document.getElementById('planEditForm');
    const event = window.currentEvent;
    if (!event || !form.splitDate.value) {
      alert('Veuillez sélectionner une date de division');
      return;
    }

    try {
      const res = await fetch('/planning/' + form.planningId.value + '/split', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          _token: event.extendedProps.csrfSplit,
          splitDate: form.splitDate.value
        })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Split failed');

      location.reload();
    } catch (err) {
      alert(err.message);
    }
  });

  // Create button
  document.getElementById('planCreateSave').addEventListener('click', async function() {
    const form = document.getElementById('planCreateForm');

    if (!form.projectId.value || !form.startDate.value || !form.endDate.value) {
      alert('Veuillez remplir tous les champs obligatoires');
      return;
    }

    try {
      const res = await fetch('/planning/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          _token: '{{ csrf_token('create_planning') }}',
          contributorId: form.contributorId.value,
          projectId: form.projectId.value,
          startDate: form.startDate.value,
          endDate: form.endDate.value,
          dailyHours: form.dailyHours.value,
          status: form.status.value,
          notes: form.notes.value
        })
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Create failed');

      // Redirect to the start date of the created planning
      const url = new URL(window.location.href);
      url.searchParams.set('start', data.startDate);
      window.location.href = url.toString();
    } catch (err) {
      alert('Erreur: ' + err.message);
    }
  });
});
</script>
{% endblock %}
