{% extends 'layouts/base.html.twig' %}

{% block title %}Modifier {{ order.orderNumber }}{% endblock %}

{% block content %}
    {% include 'components/page_header.html.twig' with {
        title: 'Modifier le devis',
        breadcrumb: [
            {label: 'Devis', path: 'order_index'},
            {label: order.orderNumber, path: 'order_show', params: {id: order.id}}
        ],
        actions: [
            {label: 'Voir le devis', path: 'order_show', params: {id: order.id}, icon: 'bx-show', class: 'btn-secondary'}
        ]
    } %}

    {{ form_start(form) }}
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bx bx-file-blank me-2"></i>
                        Informations du devis
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                {{ form_row(form.name) }}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form_row(form.project) }}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                {{ form_row(form.status) }}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                {{ form_row(form.contractType) }}
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        {{ form_row(form.description) }}
                    </div>

                    <div class="mb-3">
                        {{ form_row(form.notes) }}
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form_row(form.contingencyPercentage) }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form_row(form.validUntil) }}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form_row(form.contingenceAmount) }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form_row(form.contingenceReason) }}
                            </div>
                        </div>
                    </div>

                    {% include 'components/form_buttons.html.twig' with {
                        cancel_route: 'order_show',
                        cancel_params: {id: order.id},
                        submit_label: 'Enregistrer',
                        layout: 'horizontal'
                    } %}
                </div>
            </div>
        </div>
    {{ form_end(form) }}

        <div class="col-lg-4">
        {% if order.contractType == 'forfait' %}
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bx bx-calendar me-2"></i>
                        Échéancier de paiement
                    </h5>
                </div>
                <div class="card-body">
                    <div id="schedule-box">
                    {% if order.paymentSchedules|length > 0 %}
                        <div class="table-responsive mb-3">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th class="text-end">Montant</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {# total de référence pour l’échéancier: total sections – contingence, ou totalAmount si sections=0 #}
                                    {% set _base = order.calculateTotalFromSections() %}
                                    {% set _base = _base > 0 ? _base : order.totalAmount %}
                                    {% set _cont = order.contingencyPercentage ? order.contingencyPercentage : 0 %}
                                    {% set total = _base - (_base * _cont / 100) %}
                                    {% set scheduled = 0 %}
                                    {% for s in order.paymentSchedules %}
                                        {% set amount = s.computeAmount(total) %}
                                        {% set scheduled = scheduled + amount %}
                                        <tr>
                                            <td>{{ s.billingDate|date('Y-m-d') }}</td>
                                            <td>
                                                {% if s.amountType == 'percent' %}
                                                    {{ s.percent }}%
                                                {% else %}
                                                    Fixe
                                                {% endif %}
                                            </td>
                                            <td class="text-end">{{ amount|number_format(2, ',', ' ') }} €</td>
                                            <td class="text-end">
                                                <form method="post" action="{{ path('order_schedule_delete', {orderId: order.id, scheduleId: s.id}) }}" onsubmit="return confirm('Supprimer cette échéance ?');">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bx bx-trash"></i></button>
                                                </form>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% set pct = total > 0 ? (scheduled / total * 100) : 0 %}
                        <div class="alert {% if scheduled == total and total > 0 %}alert-success{% else %}alert-warning{% endif %}">
                            Couverture: {{ scheduled|number_format(2, ',', ' ') }} € / {{ total|number_format(2, ',', ' ') }} € ({{ pct|number_format(0, ',', ' ') }}%)
                            {% if scheduled != total %}<br><small>La somme des échéances doit couvrir 100% du devis.</small>{% endif %}
                        </div>
                        <span id="schedule-coverage-meta" data-total="{{ total|number_format(2, '.', '') }}" data-scheduled="{{ scheduled|number_format(2, '.', '') }}" hidden></span>
                    {% else %}
                        <p class="text-muted">Aucune échéance définie.</p>
                        <span id="schedule-coverage-meta" data-total="{{ (order.totalAmount ?? 0)|number_format(2, '.', '') }}" data-scheduled="0.00" hidden></span>
                    {% endif %}
                    </div>

                    <hr>
                    <h6>Ajouter une échéance</h6>
                    {# Expose le total au JS pour le calcul auto du montant #}
                    {% set _baseAdd = order.calculateTotalFromSections() %}
                    {% set _baseAdd = _baseAdd > 0 ? _baseAdd : order.totalAmount %}
                    {% set _contAdd = order.contingencyPercentage ? order.contingencyPercentage : 0 %}
                    {% set _totalForJs = _baseAdd - (_baseAdd * _contAdd / 100) %}
                    <form method="post" action="{{ path('order_schedule_add', {id: order.id}) }}" id="schedule-add-form" data-order-total="{{ _totalForJs|number_format(2, '.', '') }}">
                        <input type="hidden" name="_token" value="{{ csrf_token('schedule_add_' ~ order.id) }}">
                        <div class="mb-2">
                            <label class="form-label">Libellé</label>
                            <input type="text" class="form-control" name="label" placeholder="ex: Acompte 30%">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Date de facturation</label>
                            <input type="date" class="form-control" name="billing_date" required>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Type de montant</label>
                            <select class="form-select" name="amount_type" id="amount_type">
                                <option value="percent">Pourcentage</option>
                                <option value="fixed">Montant fixe (€)</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <label class="form-label">Pourcentage (%)</label>
                                    <input type="number" class="form-control" name="percent" min="0" max="100" step="0.1">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <label class="form-label">Montant (€)</label>
                                    <input type="number" class="form-control" name="fixed_amount" min="0" step="0.01">
                                </div>
                            </div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-outline-primary"><i class="bx bx-plus"></i> Ajouter</button>
                        </div>
                    </form>

                    <script>
                    (function(){
                      const form = document.getElementById('schedule-add-form');
                      const scheduleBox = document.getElementById('schedule-box');
                      if (!form || !scheduleBox) return;
                      const orderTotal = parseFloat(form.dataset.orderTotal || '0');
                      const amountType = form.querySelector('select[name="amount_type"]');
                      const percentInput = form.querySelector('input[name="percent"]');
                      const fixedInput = form.querySelector('input[name="fixed_amount"]');

                      function syncFields() {
                        if ((amountType.value || '').toLowerCase() === 'percent') {
                          percentInput.removeAttribute('disabled');
                          fixedInput.setAttribute('readonly', 'readonly');
                          const pct = parseFloat(percentInput.value || '0');
                          const calc = isFinite(orderTotal) ? (orderTotal * (pct/100)) : 0;
                          fixedInput.value = calc.toFixed(2);
                        } else {
                          percentInput.setAttribute('disabled', 'disabled');
                          fixedInput.removeAttribute('readonly');
                        }
                      }

                      function showSpinner(){
                        scheduleBox.innerHTML = '<div class="d-flex justify-content-center my-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Chargement...</span></div></div>';
                      }

                      function ensureToastContainer(){
                        let tc = document.getElementById('toast-container');
                        if (!tc) {
                          tc = document.createElement('div');
                          tc.id = 'toast-container';
                          tc.style.position = 'fixed';
                          tc.style.top = '1rem';
                          tc.style.right = '1rem';
                          tc.style.zIndex = '1080';
                          tc.style.minWidth = '280px';
                          document.body.appendChild(tc);
                        }
                        return tc;
                      }
                      function showToast(type, message){
                        const tc = ensureToastContainer();
                        const div = document.createElement('div');
                        div.className = 'alert alert-' + (type || 'info') + ' shadow mb-2';
                        div.textContent = message;
                        tc.appendChild(div);
                        setTimeout(()=>{ div.remove(); }, 3000);
                      }

                      async function refreshScheduleBox() {
                        try {
                          showSpinner();
                          const resp = await fetch(window.location.href, {headers: {'X-Requested-With':'fetch'}});
                          const html = await resp.text();
                          const tmp = document.createElement('div');
                          tmp.innerHTML = html;
                          const fresh = tmp.querySelector('#schedule-box');
                          if (fresh) {
                            scheduleBox.innerHTML = fresh.innerHTML;
                          }
                          // After refresh, try to read coverage and toast
                          const meta = scheduleBox.querySelector('#schedule-coverage-meta');
                          if (meta) {
                            const t = parseFloat(meta.dataset.total || '0');
                            const s = parseFloat(meta.dataset.scheduled || '0');
                            const p = t > 0 ? Math.round((s/t)*100) : 0;
                            if (t > 0) {
                              showToast(p === 100 ? 'success' : 'warning', 'Couverture échéancier: ' + p + '%');
                            }
                          }
                        } catch(e) { /* noop */ }
                      }

                      // Intercept add form submit to avoid full reload
                      form.addEventListener('submit', async function(e){
                        e.preventDefault();
                        const fd = new FormData(form);
                        try {
                          showSpinner();
                          await fetch(form.action, {method: 'POST', body: fd});
                          await refreshScheduleBox();
                          // rebind inputs after refresh
                          setTimeout(bindAfterRefresh, 0);
                        } catch(e) { /* noop */ }
                      });

                      // Delegate delete submits inside scheduleBox
                      scheduleBox.addEventListener('submit', async function(e){
                        const target = e.target;
                        if (target && target.matches('form[action*="/schedule/"]')) {
                          e.preventDefault();
                          const fd = new FormData(target);
                          try {
                            showSpinner();
                            await fetch(target.action, {method: 'POST', body: fd});
                            await refreshScheduleBox();
                            setTimeout(bindAfterRefresh, 0);
                          } catch(e) { /* noop */ }
                        }
                      });

                      function bindAfterRefresh() {
                        const newForm = document.getElementById('schedule-add-form');
                        if (!newForm) return;
                        // re-grab refs
                        const amountSel = newForm.querySelector('select[name="amount_type"]');
                        const pctIn = newForm.querySelector('input[name="percent"]');
                        const fixIn = newForm.querySelector('input[name="fixed_amount"]');
                        const tot = parseFloat(newForm.dataset.orderTotal || '0');
                        function sync2(){
                          if ((amountSel.value || '').toLowerCase() === 'percent') {
                            pctIn.removeAttribute('disabled');
                            fixIn.setAttribute('readonly','readonly');
                            const p = parseFloat(pctIn.value || '0');
                            const calc = isFinite(tot) ? (tot * (p/100)) : 0;
                            fixIn.value = calc.toFixed(2);
                          } else {
                            pctIn.setAttribute('disabled','disabled');
                            fixIn.removeAttribute('readonly');
                          }
                        }
                        amountSel.addEventListener('change', sync2);
                        pctIn.addEventListener('input', sync2);
                        sync2();
                      }

                      amountType.addEventListener('change', syncFields);
                      percentInput.addEventListener('input', syncFields);
                      // init
                      syncFields();
                    })();
                    </script>
                </div>
            </div>
        </div>
        {% else %}
            <div class="card">
                <div class="card-body">
                    <div class="alert alert-info mb-0">Contrat en régie: la facturation est calculée automatiquement selon les temps passés.</div>
                </div>
            </div>
        {% endif %}

            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bx bx-info-circle me-2"></i>
                        Informations
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>Numéro de devis</h6>
                        <p class="text-muted">{{ order.orderNumber }}</p>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Date de création</h6>
                        <p class="text-muted">{{ order.createdAt|date('d/m/Y à H:i') }}</p>
                    </div>

                    {% if order.validatedAt %}
                        <div class="mb-3">
                            <h6>Date de validation</h6>
                            <p class="text-muted">{{ order.validatedAt|date('d/m/Y à H:i') }}</p>
                        </div>
                    {% endif %}

                    <div class="mb-3">
                        <h6>Montant total</h6>
                        <p class="text-success h5">{{ order.totalAmount|number_format(2, ',', ' ') }}€</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
