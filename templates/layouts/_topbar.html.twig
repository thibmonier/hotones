<header id="page-topbar">
    <div class="navbar-header">
        <div class="d-flex">
            <!-- LOGO -->
            <div class="navbar-brand-box">
<a href="/" class="logo logo-dark">
                    <span class="logo-sm">
                        <picture>
                            <source srcset="{{ asset('assets/images/logo-hotones-dark-24.webp') }}" type="image/webp">
                            <img src="{{ asset('assets/images/logo-hotones-dark-24.png') }}" alt="HotOnes" height="24">
                        </picture>
                    </span>
                    <span class="logo-lg">
                        <picture>
                            <source srcset="{{ asset('assets/images/logo-hotones-light.svg') }}" type="image/svg+xml">
                            <source srcset="{{ asset('assets/images/logo-hotones-light-250.webp') }}" type="image/webp">
                            <img src="{{ asset('assets/images/logo-hotones-light-250.png') }}" alt="HotOnes" width="250">
                        </picture>
                    </span>
                </a>

                <a href="/" class="logo logo-light">
                    <span class="logo-sm">
                        <picture>
                            <source srcset="{{ asset('assets/images/logo-hotones-light-24.webp') }}" type="image/webp">
                            <img src="{{ asset('assets/images/logo-hotones-light-24.png') }}" alt="HotOnes" height="24">
                        </picture>
                    </span>
                    <span class="logo-lg">
                        <picture>
                            <source srcset="{{ asset('assets/images/logo-hotones-light.svg') }}" type="image/svg+xml">
                            <source srcset="{{ asset('assets/images/logo-hotones-light-250.webp') }}" type="image/webp">
                            <img src="{{ asset('assets/images/logo-hotones-light-250.png') }}" alt="HotOnes" width="250">
                        </picture>
                    </span>
                </a>
            </div>

            <button type="button" class="btn btn-sm px-3 font-size-16 header-item waves-effect" id="vertical-menu-btn">
                <i class="fa fa-fw fa-bars"></i>
            </button>

            <!-- App Search-->
            <form class="app-search d-none d-lg-block" id="topbar-search-form">
                <div class="position-relative">
                    <input type="text" class="form-control" placeholder="Rechercher... (Ctrl+K)" id="topbar-search-input" autocomplete="off">
                    <span class="bx bx-search-alt"></span>
                    <div id="topbar-search-results" class="dropdown-menu dropdown-menu-lg" style="display: none; position: absolute; top: 100%; left: 0; width: 500px; max-height: 400px; overflow-y: auto; z-index: 1050;"></div>
                </div>
            </form>

{#            <div class="dropdown dropdown-mega d-none d-lg-block ms-2">#}
{#                <button type="button" class="btn header-item waves-effect" data-bs-toggle="dropdown" aria-haspopup="false" aria-expanded="false">#}
{#                    <span key="t-megamenu">Mega Menu</span>#}
{#                    <i class="mdi mdi-chevron-down"></i>#}
{#                </button>#}
{#                <div class="dropdown-menu dropdown-megamenu">#}
{#                    <div class="row">#}
{#                        <div class="col-sm-8">#}

{#                            <div class="row">#}
{#                                <div class="col-md-4">#}
{#                                    <h5 class="font-size-14" key="t-ui-components">UI Components</h5>#}
{#                                    <ul class="list-unstyled megamenu-list">#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-lightbox">Lightbox</a>#}
{#                                        </li>#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-range-slider">Range Slider</a>#}
{#                                        </li>#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-sweet-alert">Sweet Alert</a>#}
{#                                        </li>#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-rating">Rating</a>#}
{#                                        </li>#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-forms">Forms</a>#}
{#                                        </li>#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-tables">Tables</a>#}
{#                                        </li>#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-charts">Charts</a>#}
{#                                        </li>#}
{#                                    </ul>#}
{#                                </div>#}

{#                                <div class="col-md-4">#}
{#                                    <h5 class="font-size-14" key="t-applications">Applications</h5>#}
{#                                    <ul class="list-unstyled megamenu-list">#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-ecommerce">Ecommerce</a>#}
{#                                        </li>#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-calendar">Calendar</a>#}
{#                                        </li>#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-email">Email</a>#}
{#                                        </li>#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-projects">Projects</a>#}
{#                                        </li>#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-tasks">Tasks</a>#}
{#                                        </li>#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-contacts">Contacts</a>#}
{#                                        </li>#}
{#                                    </ul>#}
{#                                </div>#}

{#                                <div class="col-md-4">#}
{#                                    <h5 class="font-size-14" key="t-extra-pages">Extra Pages</h5>#}
{#                                    <ul class="list-unstyled megamenu-list">#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-light-sidebar">Light Sidebar</a>#}
{#                                        </li>#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-compact-sidebar">Compact Sidebar</a>#}
{#                                        </li>#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-horizontal">Horizontal layout</a>#}
{#                                        </li>#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-maintenance">Maintenance</a>#}
{#                                        </li>#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-coming-soon">Coming Soon</a>#}
{#                                        </li>#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-timeline">Timeline</a>#}
{#                                        </li>#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-faqs">FAQs</a>#}
{#                                        </li>#}

{#                                    </ul>#}
{#                                </div>#}
{#                            </div>#}
{#                        </div>#}
{#                        <div class="col-sm-4">#}
{#                            <div class="row">#}
{#                                <div class="col-sm-6">#}
{#                                    <h5 class="font-size-14" key="t-ui-components">UI Components</h5>#}
{#                                    <ul class="list-unstyled megamenu-list">#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-lightbox">Lightbox</a>#}
{#                                        </li>#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-range-slider">Range Slider</a>#}
{#                                        </li>#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-sweet-alert">Sweet Alert</a>#}
{#                                        </li>#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-rating">Rating</a>#}
{#                                        </li>#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-forms">Forms</a>#}
{#                                        </li>#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-tables">Tables</a>#}
{#                                        </li>#}
{#                                        <li>#}
{#                                            <a href="javascript:void(0);" key="t-charts">Charts</a>#}
{#                                        </li>#}
{#                                    </ul>#}
{#                                </div>#}

{#                                <div class="col-sm-5">#}
{#                                    <div>#}
{#                                        <img src="/assets/images/megamenu-img.png" alt="" class="img-fluid mx-auto d-block">#}
{#                                    </div>#}
{#                                </div>#}
{#                            </div>#}
{#                        </div>#}
{#                    </div>#}

{#                </div>#}
{#            </div>#}
        </div>

        <div class="d-flex">

            <div class="dropdown d-inline-block d-lg-none ms-2">
                <button type="button" class="btn header-item noti-icon waves-effect" id="page-header-search-dropdown"
                data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="mdi mdi-magnify"></i>
                </button>
                <div class="dropdown-menu dropdown-menu-lg dropdown-menu-end p-0"
                    aria-labelledby="page-header-search-dropdown">

                    <form class="p-3">
                        <div class="form-group m-0">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Search ..." aria-label="Recipient's username">
                                <div class="input-group-append">
                                    <button class="btn btn-primary" type="submit"><i class="mdi mdi-magnify"></i></button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

{#            <div class="dropdown d-inline-block">#}
{#                <button type="button" class="btn header-item waves-effect"#}
{#                data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">#}
{#                    <img id="header-lang-img" src="/assets/images/flags/us.jpg" alt="Header Language" height="16">#}
{#                </button>#}
{#                <div class="dropdown-menu dropdown-menu-end">#}

{#                    <!-- item-->#}
{#                    <a href="javascript:void(0);" class="dropdown-item notify-item language" data-lang="en">#}
{#                        <img src="/assets/images/flags/us.jpg" alt="user-image" class="me-1" height="12"> <span class="align-middle">English</span>#}
{#                    </a>#}
{#                    <!-- item-->#}
{#                    <a href="javascript:void(0);" class="dropdown-item notify-item language" data-lang="sp">#}
{#                        <img src="/assets/images/flags/spain.jpg" alt="user-image" class="me-1" height="12"> <span class="align-middle">Spanish</span>#}
{#                    </a>#}

{#                    <!-- item-->#}
{#                    <a href="javascript:void(0);" class="dropdown-item notify-item language" data-lang="gr">#}
{#                        <img src="/assets/images/flags/germany.jpg" alt="user-image" class="me-1" height="12"> <span class="align-middle">German</span>#}
{#                    </a>#}

{#                    <!-- item-->#}
{#                    <a href="javascript:void(0);" class="dropdown-item notify-item language" data-lang="it">#}
{#                        <img src="/assets/images/flags/italy.jpg" alt="user-image" class="me-1" height="12"> <span class="align-middle">Italian</span>#}
{#                    </a>#}

{#                    <!-- item-->#}
{#                    <a href="javascript:void(0);" class="dropdown-item notify-item language" data-lang="ru">#}
{#                        <img src="/assets/images/flags/russia.jpg" alt="user-image" class="me-1" height="12"> <span class="align-middle">Russian</span>#}
{#                    </a>#}
{#                </div>#}
{#            </div>#}

{#            <div class="dropdown d-none d-lg-inline-block ms-1">#}
{#                <button type="button" class="btn header-item noti-icon waves-effect"#}
{#                data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">#}
{#                    <i class="bx bx-customize"></i>#}
{#                </button>#}
{#                <div class="dropdown-menu dropdown-menu-lg dropdown-menu-end">#}
{#                    <div class="px-lg-2">#}
{#                        <div class="row g-0">#}
{#                            <div class="col">#}
{#                                <a class="dropdown-icon-item" href="#">#}
{#                                    <img src="/assets/images/brands/github.png" alt="Github">#}
{#                                    <span>GitHub</span>#}
{#                                </a>#}
{#                            </div>#}
{#                            <div class="col">#}
{#                                <a class="dropdown-icon-item" href="#">#}
{#                                    <img src="/assets/images/brands/bitbucket.png" alt="bitbucket">#}
{#                                    <span>Bitbucket</span>#}
{#                                </a>#}
{#                            </div>#}
{#                            <div class="col">#}
{#                                <a class="dropdown-icon-item" href="#">#}
{#                                    <img src="/assets/images/brands/dribbble.png" alt="dribbble">#}
{#                                    <span>Dribbble</span>#}
{#                                </a>#}
{#                            </div>#}
{#                        </div>#}

{#                        <div class="row g-0">#}
{#                            <div class="col">#}
{#                                <a class="dropdown-icon-item" href="#">#}
{#                                    <img src="/assets/images/brands/dropbox.png" alt="dropbox">#}
{#                                    <span>Dropbox</span>#}
{#                                </a>#}
{#                            </div>#}
{#                            <div class="col">#}
{#                                <a class="dropdown-icon-item" href="#">#}
{#                                    <img src="/assets/images/brands/mail_chimp.png" alt="mail_chimp">#}
{#                                    <span>Mail Chimp</span>#}
{#                                </a>#}
{#                            </div>#}
{#                            <div class="col">#}
{#                                <a class="dropdown-icon-item" href="#">#}
{#                                    <img src="/assets/images/brands/slack.png" alt="slack">#}
{#                                    <span>Slack</span>#}
{#                                </a>#}
{#                            </div>#}
{#                        </div>#}
{#                    </div>#}
{#                </div>#}
{#            </div>#}

            <div class="dropdown d-none d-lg-inline-block ms-1">
                <button type="button" class="btn header-item noti-icon waves-effect" data-bs-toggle="fullscreen">
                    <i class="bx bx-fullscreen"></i>
                </button>
            </div>

            {# Compteur de temps - démarrage rapide #}
            <div class="dropdown d-inline-block ms-1">
                <button type="button" class="btn header-item noti-icon waves-effect position-relative" id="page-header-timer-dropdown"
                        data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="Démarrer un compteur">
                    <i class="bx bx-time-five" id="timer-icon"></i>
                    <span class="position-absolute top-0 start-100 translate-middle p-1 bg-success border border-light rounded-circle" id="timer-active-dot" style="display:none;"></span>
                </button>
                <div class="dropdown-menu dropdown-menu-lg dropdown-menu-end p-0"
                     aria-labelledby="page-header-timer-dropdown" style="min-width: 320px;">
                    <div class="p-3 border-bottom">
                        <h6 class="m-0">Compteur de temps</h6>
                    </div>
                    <div class="p-3">
                        <div class="mb-2">
                            <label class="form-label mb-1">Projet</label>
                            <select class="form-select" id="timer-project-select" disabled>
                                <option>Chargement...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label mb-1">Tâche</label>
                            <select class="form-select" id="timer-task-select" disabled>
                                <option>—</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label mb-1">Sous-tâche (optionnel)</label>
                            <select class="form-select" id="timer-subtask-select" disabled>
                                <option value="">—</option>
                            </select>
                        </div>
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-outline-danger btn-sm" id="timer-stop-btn" disabled>
                                <i class="bx bx-stop me-1"></i> Arrêter
                            </button>
                            <button class="btn btn-success btn-sm" id="timer-start-btn" disabled>
                                <i class="bx bx-play me-1"></i> Démarrer
                            </button>
                        </div>
                        <div class="mt-2 text-muted small" id="timer-status"></div>
                    </div>
                </div>
            </div>

            <div class="dropdown d-inline-block">
                <button type="button" class="btn header-item noti-icon waves-effect" id="page-header-notifications-dropdown"
                data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="bx bx-bell bx-tada"></i>
                    <span class="badge bg-danger rounded-pill" id="notification-count" style="display: none;">0</span>
                </button>
                <div class="dropdown-menu dropdown-menu-lg dropdown-menu-end p-0"
                    aria-labelledby="page-header-notifications-dropdown">
                    <div class="p-3">
                        <div class="row align-items-center">
                            <div class="col">
                                <h6 class="m-0">Notifications</h6>
                            </div>
                            <div class="col-auto">
                                <a href="{{ path('notification_index') }}" class="small">Tout voir</a>
                            </div>
                        </div>
                    </div>
                    <div id="notification-list" data-simplebar style="max-height: 300px;">
                        <div class="text-center text-muted py-3">
                            <i class="bx bx-loader bx-spin font-size-18"></i>
                            <p class="mb-0 mt-2">Chargement...</p>
                        </div>
                    </div>
                    <div class="p-2 border-top d-grid">
                        <div class="d-flex justify-content-between">
                          <a class="btn btn-sm btn-link font-size-14" href="{{ path('notification_index') }}">
                            <i class="mdi mdi-arrow-right-circle me-1"></i> <span>Voir toutes</span>
                          </a>
                          <a class="btn btn-sm btn-link font-size-14" href="{{ path('profile_notifications') }}">
                            <i class="bx bx-cog me-1"></i> <span>Mes préférences</span>
                          </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dropdown d-inline-block ms-1">
                <button type="button" class="btn header-item noti-icon waves-effect" id="page-header-tasks-dropdown"
                        data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="Mes tâches">
                    <i class="bx bx-task"></i>
                    <span class="badge bg-warning rounded-pill" id="task-overdue-count" style="display: none;">0</span>
                </button>
                <div class="dropdown-menu dropdown-menu-lg dropdown-menu-end p-0"
                     aria-labelledby="page-header-tasks-dropdown">
                    <div class="p-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <h6 class="m-0">Tâches en retard</h6>
                            <a href="{{ path('my_tasks_index') }}" class="small">Tout voir</a>
                        </div>
                    </div>
                    <div id="task-overdue-list" data-simplebar style="max-height: 300px;">
                        <div class="text-center text-muted py-3">
                            <i class="bx bx-loader bx-spin font-size-18"></i>
                            <p class="mb-0 mt-2">Chargement...</p>
                        </div>
                    </div>
                    <div class="p-2 border-top d-grid">
                        <a class="btn btn-sm btn-link font-size-14 text-center" href="{{ path('my_tasks_index') }}">
                            <i class="mdi mdi-arrow-right-circle me-1"></i> <span>Voir mes tâches</span>
                        </a>
                    </div>
                </div>
            </div>

            {% if is_granted('ROLE_MANAGER') %}
            <div class="dropdown d-inline-block ms-1">
                <button type="button" class="btn header-item noti-icon waves-effect" id="page-header-vacations-dropdown"
                        data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="Demandes de congés">
                    <i class="bx bx-calendar-exclamation"></i>
                    <span class="badge bg-warning rounded-pill" id="vacation-pending-count" style="display: none;">0</span>
                </button>
                <div class="dropdown-menu dropdown-menu-lg dropdown-menu-end p-0"
                     aria-labelledby="page-header-vacations-dropdown">
                    <div class="p-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <h6 class="m-0">Demandes en attente</h6>
                            <a href="{{ path('vacation_approval_index') }}" class="small">Tout voir</a>
                        </div>
                    </div>
                    <div id="vacation-pending-list" data-simplebar style="max-height: 300px;">
                        <div class="text-center text-muted py-3">
                            <i class="bx bx-loader bx-spin font-size-18"></i>
                            <p class="mb-0 mt-2">Chargement...</p>
                        </div>
                    </div>
                    <div class="p-2 border-top d-grid">
                        <a class="btn btn-sm btn-link font-size-14 text-center" href="{{ path('vacation_approval_index') }}">
                            <i class="mdi mdi-arrow-right-circle me-1"></i> <span>Voir toutes les demandes</span>
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="dropdown d-inline-block">
                <button type="button" class="btn header-item waves-effect" id="page-header-user-dropdown"
                data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
<img class="rounded-circle header-profile-user" src="{{ app.user and app.user.avatar ? app.user.avatar : asset('assets/images/users/avatar-1.jpg') }}"
                        alt="Header Avatar">
                    <span class="d-none d-xl-inline-block ms-1">{{ app.user ? app.user.firstName : '' }}</span>
                    <i class="mdi mdi-chevron-down d-none d-xl-inline-block"></i>
                </button>
                <div class="dropdown-menu dropdown-menu-end">
                    <!-- item-->
<a class="dropdown-item" href="{{ path('profile_me') }}"><i class="bx bx-user font-size-16 align-middle me-1"></i> Mon compte</a>
<a class="dropdown-item d-flex align-items-center justify-content-between" href="{{ path('profile_notifications') }}">
  <span><i class="bx bx-bell font-size-16 align-middle me-1"></i> Mes notifications</span>
  <span id="user-menu-unread-count" class="badge bg-danger rounded-pill" style="display:none;">0</span>
</a>
<a class="dropdown-item d-flex align-items-center justify-content-between" href="{{ path('my_tasks_index') }}">
  <span><i class="bx bx-task font-size-16 align-middle me-1"></i> Mes tâches</span>
  <span id="user-menu-overdue-tasks-count" class="badge bg-warning rounded-pill" style="display:none;">0</span>
</a>
<a class="dropdown-item" href="{{ path('vacation_request_index') }}"><i class="bx bx-calendar font-size-16 align-middle me-1"></i> Mes congés</a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item text-danger" href="{{ path('app_logout') }}"><i class="bx bx-power-off font-size-16 align-middle me-1 text-danger"></i> Déconnexion</a>
                </div>
            </div>

            <div class="dropdown d-inline-block">
                <button type="button" class="btn header-item noti-icon right-bar-toggle waves-effect">
                    <i class="bx bx-cog bx-spin"></i>
                </button>
            </div>

        </div>
    </div>
</header>
<script>
  (function(){
    var unreadInterval = null;

    // ---- Compteur de temps (topbar) ----
    var timerLoaded = false;
    var timerProjects = []; // [{id, name, tasks: [{id,name}, ...]}]
    var projectSelect = null, taskSelect = null, subTaskSelect = null, startBtn = null, stopBtn = null, statusEl = null, activeDot = null;

    var timerTooltipInterval = null;
    var timerIcon = null;
    var activeStart = null;
    var activeLabelBase = '';

    function setTimerActive(active, label, startedAtIso) {
      if (!activeDot) return;
      activeDot.style.display = active ? 'block' : 'none';
      if (statusEl) statusEl.textContent = label || '';
      if (stopBtn) stopBtn.disabled = !active;
      if (!timerIcon) timerIcon = document.getElementById('timer-icon');
      if (timerIcon) {
        if (active) timerIcon.classList.add('bx-spin'); else timerIcon.classList.remove('bx-spin');
      }
      if (active) {
        activeStart = startedAtIso ? new Date(startedAtIso) : new Date();
        activeLabelBase = label || '';
        if (timerTooltipInterval) clearInterval(timerTooltipInterval);
        timerTooltipInterval = setInterval(function(){
          var s = Math.floor((Date.now() - activeStart.getTime())/1000);
          var h = Math.floor(s/3600);
          var m = Math.floor((s%3600)/60).toString().padStart(2,'0');
          var sec = (s%60).toString().padStart(2,'0');
          var title = (activeLabelBase ? activeLabelBase + ' — ' : '') + h+":"+m+":"+sec;
          var btn = document.getElementById('page-header-timer-dropdown');
          if (btn) btn.setAttribute('title', title);
        }, 1000);
      } else {
        if (timerTooltipInterval) clearInterval(timerTooltipInterval);
        var btn = document.getElementById('page-header-timer-dropdown');
        if (btn) btn.setAttribute('title', 'Démarrer un compteur');
      }
    }

    function loadTimerActive() {
      fetch('{{ path('timesheet_timer_active') }}')
        .then(r => r.json())
        .then(data => {
          if (data && data.timer) {
            var suffix = '';
            if (data.timer.task) { suffix += ' · ' + data.timer.task.name; }
            if (data.timer.subTask) { suffix += ' · ' + data.timer.subTask.title; }
            setTimerActive(true, 'En cours: ' + data.timer.project.name + suffix, data.timer.started_at);
          } else {
            setTimerActive(false, 'Aucun compteur en cours');
          }
        })
        .catch(() => setTimerActive(false, ''));
    }

    function loadTimerOptions() {
      return fetch('{{ path('timesheet_timer_options') }}')
        .then(r => r.json())
        .then(data => {
          timerProjects = data.projects || [];
          // Remplir le select projet
          projectSelect.innerHTML = '<option value="">Sélectionner un projet</option>';
          timerProjects.forEach(p => {
            var opt = document.createElement('option');
            opt.value = p.id; opt.textContent = p.name;
            projectSelect.appendChild(opt);
          });
          projectSelect.disabled = false;
          taskSelect.innerHTML = '<option value="">Sélectionner une tâche</option>';
          taskSelect.disabled = true;
          startBtn.disabled = true;
        });
    }

    function onProjectChange() {
      var pid = projectSelect.value;
      var proj = timerProjects.find(p => String(p.id) === String(pid));
      taskSelect.innerHTML = '<option value="">Sélectionner une tâche</option>';
      subTaskSelect.innerHTML = '<option value="">—</option>';
      subTaskSelect.disabled = true;
      if (!proj) { taskSelect.disabled = true; startBtn.disabled = true; return; }
      (proj.tasks || []).forEach(t => {
        var opt = document.createElement('option');
        opt.value = t.id; opt.textContent = t.name;
        opt.dataset.subtasks = JSON.stringify(t.subTasks || []);
        taskSelect.appendChild(opt);
      });
      taskSelect.disabled = false;
      startBtn.disabled = false;
    }

    function onTaskChange() {
      var opt = taskSelect.options[taskSelect.selectedIndex];
      subTaskSelect.innerHTML = '<option value="">—</option>';
      subTaskSelect.disabled = true;
      if (!opt || !opt.dataset.subtasks) return;
      try {
        var subs = JSON.parse(opt.dataset.subtasks) || [];
        subs.forEach(function(s){
          var o = document.createElement('option'); o.value = s.id; o.textContent = s.title; subTaskSelect.appendChild(o);
        });
        subTaskSelect.disabled = subs.length === 0;
      } catch(e) { /* noop */ }
    }

    document.addEventListener('DOMContentLoaded', function(){
      projectSelect = document.getElementById('timer-project-select');
      taskSelect = document.getElementById('timer-task-select');
      subTaskSelect = document.getElementById('timer-subtask-select');
      startBtn = document.getElementById('timer-start-btn');
      stopBtn = document.getElementById('timer-stop-btn');
      statusEl = document.getElementById('timer-status');
      activeDot = document.getElementById('timer-active-dot');

      if (projectSelect) {
        projectSelect.addEventListener('change', onProjectChange);
      }
      if (taskSelect) {
        taskSelect.addEventListener('change', onTaskChange);
      }

      if (startBtn) {
        startBtn.addEventListener('click', function(){
          var pid = projectSelect.value; var tid = taskSelect.value; var sid = subTaskSelect.value;
          if (!pid) return;
          var params = new URLSearchParams({ project_id: pid });
          if (tid) params.append('task_id', tid);
          if (sid) params.append('sub_task_id', sid);
          fetch('{{ path('timesheet_timer_start') }}', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: params })
            .then(r => r.json())
            .then(data => {
              if (!data.success) { alert(data.error || 'Erreur'); return; }
              var suffix = '';
              if (data.timer.task) { suffix += ' · ' + data.timer.task.name; }
              if (data.timer.subTask) { suffix += ' · ' + data.timer.subTask.title; }
              setTimerActive(true, 'En cours: ' + data.timer.project.name + suffix, data.timer.started_at);
            })
            .catch(() => alert('Erreur de connexion'));
        });
      }

      if (stopBtn) {
        stopBtn.addEventListener('click', function(){
          fetch('{{ path('timesheet_timer_stop') }}', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
              if (!data.success) { alert(data.error || 'Erreur'); return; }
              setTimerActive(false, 'Aucun compteur en cours');
            })
            .catch(() => alert('Erreur de connexion'));
        });
      }

      // Charger options et statut au premier affichage du menu
      var timerDropdownBtn = document.getElementById('page-header-timer-dropdown');
      if (timerDropdownBtn) {
        timerDropdownBtn.addEventListener('click', function(){
          if (!timerLoaded) {
            loadTimerOptions().then(loadTimerActive);
            timerLoaded = true;
          } else {
            loadTimerActive();
          }
        });
      }

      // Init point vert si un timer est actif
      loadTimerActive();
    });

    // ---- Filtres actifs (topbar) ----
    function updateActiveFiltersIndicator() {
      var badge = document.getElementById('active-filters-badge');
      if (!badge) return;
      var filters = Array.isArray(window.__ACTIVE_FILTERS) ? window.__ACTIVE_FILTERS : [];
      if (filters.length > 0) {
        badge.style.display = 'inline-block';
        badge.textContent = String(filters.length);
        var text = filters.slice(0, 6).join(' • ');
        badge.setAttribute('title', text);
        try { if (bootstrap && bootstrap.Tooltip) new bootstrap.Tooltip(badge); } catch(e) {}
      } else {
        badge.style.display = 'none';
        badge.removeAttribute('title');
      }
    }

    window.addEventListener('active-filters-changed', updateActiveFiltersIndicator);
    document.addEventListener('DOMContentLoaded', updateActiveFiltersIndicator);

    // ---- Notifications ----
    function updateUnreadBadges() {
      // Notifications non lues
      fetch('/notifications/api/unread')
        .then(r => r.json())
        .then(data => {
          var count = (data && typeof data.count === 'number') ? data.count : 0;
          var bell = document.getElementById('notification-count');
          var userBadge = document.getElementById('user-menu-unread-count');
          if (bell) {
            if (count > 0) { bell.style.display = 'inline-block'; bell.textContent = count; }
            else { bell.style.display = 'none'; }
          }
          if (userBadge) {
            if (count > 0) { userBadge.style.display = 'inline-block'; userBadge.textContent = count; }
            else { userBadge.style.display = 'none'; }
          }
        })
        .catch(()=>{});
      // Tâches en retard
      fetch('/tasks/api/overdue-count')
        .then(r => r.json())
        .then(data => {
          var overdue = (data && typeof data.count === 'number') ? data.count : 0;
          var noContributor = !!(data && data.no_contributor);
          var tasksBadge = document.getElementById('user-menu-overdue-tasks-count');
          var tasksTopbar = document.getElementById('task-overdue-count');
          var tasksSidebar = document.getElementById('sidebar-overdue-tasks-count');
          if (tasksBadge) {
            if (overdue > 0) { tasksBadge.style.display = 'inline-block'; tasksBadge.textContent = overdue; }
            else { tasksBadge.style.display = 'none'; }
          }
          if (tasksTopbar) {
            if (overdue > 0) { tasksTopbar.style.display = 'inline-block'; tasksTopbar.textContent = overdue; }
            else { tasksTopbar.style.display = 'none'; }
          }
          if (tasksSidebar) {
            if (overdue > 0) { tasksSidebar.style.display = 'inline-block'; tasksSidebar.textContent = overdue; }
            else { tasksSidebar.style.display = 'none'; }
          }
          // Si des tâches en retard existent, charger la liste (top 5)
          if (overdue > 0) {
            fetch('/tasks/api/overdue-list?limit=5')
              .then(r => r.json())
              .then(listData => {
                var container = document.getElementById('task-overdue-list');
                if (!container) return;
                var tasks = (listData && Array.isArray(listData.tasks)) ? listData.tasks : [];
                if (tasks.length === 0) {
                  container.innerHTML = '<div class="text-center text-muted py-3">Aucune tâche en retard</div>';
                  return;
                }
                var html = '<div class="list-group list-group-flush">';
                tasks.forEach(function(t){
                  var end = t.end_date ? ('<small class="text-muted"> (échéance '+t.end_date+')</small>') : '';
                  html += '<a class="list-group-item list-group-item-action" href="'+t.url+'">'
                        + '<div class="d-flex w-100 justify-content-between">'
                        + '<div><strong>'+t.name.replace(/</g,'&lt;')+'</strong><br><small class="text-muted">'+t.project.replace(/</g,'&lt;')+'</small></div>'
                        + end
                        + '</div>'
                        + '</a>';
                });
                html += '</div>';
                container.innerHTML = html;
              })
              .catch(()=>{});
          } else {
            var container = document.getElementById('task-overdue-list');
            if (container) container.innerHTML = noContributor
              ? '<div class="text-center text-muted py-3">Profil non lié à un contributeur</div>'
              : '<div class="text-center text-muted py-3">Aucune tâche en retard</div>';
          }
        })
        .catch(()=>{});
      // Demandes de congés en attente (managers seulement)
      var vacationBadge = document.getElementById('vacation-pending-count');
      var sidebarVacationBadge = document.getElementById('sidebar-pending-vacations-count');
      if (vacationBadge || sidebarVacationBadge) {
        fetch('/manager/conges/api/pending-count')
          .then(r => r.json())
          .then(data => {
            var count = (data && typeof data.count === 'number') ? data.count : 0;
            if (vacationBadge) {
              if (count > 0) { vacationBadge.style.display = 'inline-block'; vacationBadge.textContent = count; }
              else { vacationBadge.style.display = 'none'; }
            }
            if (sidebarVacationBadge) {
              if (count > 0) { sidebarVacationBadge.style.display = 'inline-block'; sidebarVacationBadge.textContent = count; }
              else { sidebarVacationBadge.style.display = 'none'; }
            }
            // Charger la liste des demandes
            if (count > 0) {
              var container = document.getElementById('vacation-pending-list');
              if (!container) return;
              var vacations = (data && Array.isArray(data.vacations)) ? data.vacations : [];
              if (vacations.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-3">Aucune demande en attente</div>';
                return;
              }
              var html = '<div class="list-group list-group-flush">';
              vacations.forEach(function(v){
                html += '<a class="list-group-item list-group-item-action" href="'+v.url+'">'
                      + '<div class="d-flex w-100 justify-content-between">'
                      + '<div><strong>'+v.contributor.replace(/</g,'&lt;')+'</strong><br>'
                      + '<small class="text-muted">'+v.type+' · '+v.start_date+' au '+v.end_date+' ('+v.working_days+' j.)</small></div>'
                      + '</div>'
                      + '</a>';
              });
              html += '</div>';
              container.innerHTML = html;
            } else {
              var container = document.getElementById('vacation-pending-list');
              if (container) container.innerHTML = '<div class="text-center text-muted py-3">Aucune demande en attente</div>';
            }
          })
          .catch(()=>{});
      }
    }
    function startUnreadInterval() {
      if (unreadInterval) { clearInterval(unreadInterval); }
      unreadInterval = setInterval(updateUnreadBadges, 60000); // 60s
    }
    document.addEventListener('visibilitychange', function(){
      if (document.hidden) {
        if (unreadInterval) { clearInterval(unreadInterval); unreadInterval = null; }
      } else {
        updateUnreadBadges();
        startUnreadInterval();
      }
    });
    document.addEventListener('DOMContentLoaded', function(){
      updateUnreadBadges();
      startUnreadInterval();
    });

    // ---- Global Search Autocomplete ----
    (function(){
      var searchInput = document.getElementById('topbar-search-input');
      var searchForm = document.getElementById('topbar-search-form');
      var searchResults = document.getElementById('topbar-search-results');
      var searchTimeout = null;
      var currentSelectedIndex = -1;

      if (!searchInput || !searchResults) return;

      // Keyboard shortcut: Ctrl+K
      document.addEventListener('keydown', function(e){
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
          e.preventDefault();
          searchInput.focus();
          searchInput.select();
        }
        // Escape to close results
        if (e.key === 'Escape' && searchResults.style.display === 'block') {
          searchResults.style.display = 'none';
          currentSelectedIndex = -1;
        }
      });

      // Navigate results with arrow keys
      searchInput.addEventListener('keydown', function(e){
        if (searchResults.style.display !== 'block') return;

        var items = searchResults.querySelectorAll('.search-result-item');
        if (items.length === 0) return;

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          currentSelectedIndex = Math.min(currentSelectedIndex + 1, items.length - 1);
          updateSelection(items);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          currentSelectedIndex = Math.max(currentSelectedIndex - 1, -1);
          updateSelection(items);
        } else if (e.key === 'Enter' && currentSelectedIndex >= 0) {
          e.preventDefault();
          items[currentSelectedIndex].click();
        }
      });

      function updateSelection(items){
        items.forEach(function(item, idx){
          if (idx === currentSelectedIndex) {
            item.classList.add('active');
          } else {
            item.classList.remove('active');
          }
        });
      }

      // Search on input
      searchInput.addEventListener('input', function(){
        var query = searchInput.value.trim();

        if (searchTimeout) clearTimeout(searchTimeout);

        if (query.length < 2) {
          searchResults.style.display = 'none';
          currentSelectedIndex = -1;
          return;
        }

        searchTimeout = setTimeout(function(){
          fetch('/api/search?q=' + encodeURIComponent(query))
            .then(r => r.json())
            .then(data => {
              displayResults(data, query);
            })
            .catch(function(){
              searchResults.innerHTML = '<div class="p-3 text-muted">Erreur de recherche</div>';
              searchResults.style.display = 'block';
            });
        }, 300);
      });

      function displayResults(data, query){
        currentSelectedIndex = -1;

        if (!data || Object.keys(data).length === 0) {
          searchResults.innerHTML = '<div class="p-3 text-muted"><i class="bx bx-info-circle me-2"></i>Aucun résultat pour "' + escapeHtml(query) + '"</div>';
          searchResults.style.display = 'block';
          return;
        }

        var html = '';
        var typeIcons = {
          projects: 'bx-folder-open',
          contributors: 'bx-user',
          orders: 'bx-file',
          clients: 'bx-buildings'
        };
        var typeLabels = {
          projects: 'Projets',
          contributors: 'Contributeurs',
          orders: 'Devis',
          clients: 'Clients'
        };

        Object.keys(data).forEach(function(type){
          var items = data[type];
          if (!items || items.length === 0) return;

          html += '<div class="px-3 py-2 bg-light"><small class="text-muted"><i class="bx ' + typeIcons[type] + ' me-1"></i>' + typeLabels[type] + ' (' + items.length + ')</small></div>';
          html += '<div class="list-group list-group-flush">';

          items.slice(0, 5).forEach(function(item){
            html += '<a href="' + item.url + '" class="list-group-item list-group-item-action search-result-item">';
            html += '<strong>' + escapeHtml(item.name) + '</strong>';
            html += '</a>';
          });

          html += '</div>';
        });

        html += '<div class="p-2 border-top text-center">';
        html += '<a href="{{ path('global_search') }}?q=' + encodeURIComponent(query) + '" class="small text-muted">Voir tous les résultats</a>';
        html += '</div>';

        searchResults.innerHTML = html;
        searchResults.style.display = 'block';
      }

      function escapeHtml(text){
        var map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
        return String(text).replace(/[&<>"']/g, function(m){ return map[m]; });
      }

      // Close results when clicking outside
      document.addEventListener('click', function(e){
        if (!searchForm.contains(e.target)) {
          searchResults.style.display = 'none';
          currentSelectedIndex = -1;
        }
      });

      // Prevent form submission, redirect to full search page instead
      searchForm.addEventListener('submit', function(e){
        e.preventDefault();
        var query = searchInput.value.trim();
        if (query.length >= 2) {
          window.location.href = '{{ path('global_search') }}?q=' + encodeURIComponent(query);
        }
      });
    })();
  })();
</script>
