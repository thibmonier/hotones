{% extends 'layouts/base.html.twig' %}

{% block title %}Nouveau client{% endblock %}

{% block content %}
{% include 'components/page_header.html.twig' with {
    title: 'Nouveau client',
    breadcrumb: [
        {label: 'Clients', path: 'client_index'},
        {label: 'Nouveau', path: null}
    ]
} %}

<form method="post" enctype="multipart/form-data" data-validate-on-submit>
    <div class="row">
        <div class="col-lg-8">
            {# Informations principales #}
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bx bx-info-circle me-2"></i>
                        Informations principales
                    </h5>

                    <div class="mb-3">
                        <label class="form-label" for="name">Nom du client *</label>
                        <input type="text"
                               class="form-control"
                               id="name"
                               name="name"
                               data-validation-url="{{ path('api_validate') }}"
                               data-validation-type="client_name_unique"
                               required
                               value="{{ client.name|default('') }}">
                        <div class="form-text">Nom commercial de l'entreprise</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="website">Site web</label>
                        <input type="url"
                               class="form-control"
                               id="website"
                               name="website"
                               data-validation-url="{{ path('api_validate') }}"
                               data-validation-type="url"
                               placeholder="https://example.com"
                               value="{{ client.website|default('') }}">
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="description">Description</label>
                        <textarea class="form-control"
                                  id="description"
                                  name="description"
                                  rows="3"
                                  placeholder="Description courte du client et de son activit√©">{{ client.description|default('') }}</textarea>
                    </div>
                </div>
            </div>

            {# Niveau de service #}
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bx bx-star me-2"></i>
                        Niveau de service
                    </h5>

                    <div class="mb-3">
                        <label class="form-label">Mode de d√©finition</label>
                        <select class="form-select" id="service_level_mode" name="service_level_mode">
                            <option value="auto" {{ client.serviceLevelMode == 'auto' ? 'selected' : '' }}>
                                Automatique (bas√© sur le CA)
                            </option>
                            <option value="manual" {{ client.serviceLevelMode == 'manual' ? 'selected' : '' }}>
                                Manuel
                            </option>
                        </select>
                        <div class="form-text">
                            <i class="bx bx-info-circle me-1"></i>
                            En mode auto, le niveau est calcul√© automatiquement selon le CA annuel
                        </div>
                    </div>

                    <div class="mb-0" id="manual_level_container" style="display: {{ client.serviceLevelMode == 'manual' ? 'block' : 'none' }};">
                        <label class="form-label">Niveau de service</label>
                        <select class="form-select" name="service_level">
                            <option value="">-- S√©lectionner --</option>
                            <option value="vip" {{ client.serviceLevel == 'vip' ? 'selected' : '' }}>
                                üåü VIP
                            </option>
                            <option value="priority" {{ client.serviceLevel == 'priority' ? 'selected' : '' }}>
                                ‚ö° Prioritaire
                            </option>
                            <option value="standard" {{ client.serviceLevel == 'standard' or not client.serviceLevel ? 'selected' : '' }}>
                                Standard
                            </option>
                            <option value="low" {{ client.serviceLevel == 'low' ? 'selected' : '' }}>
                                Basse priorit√©
                            </option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        {# Sidebar #}
        <div class="col-lg-4">
            {# Logo #}
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bx bx-image me-2"></i>
                        Logo
                    </h5>

                    {% if client.logoPath %}
                        <div class="mb-3 text-center">
                            <img src="{{ client.logoPath }}"
                                 alt="Logo actuel"
                                 class="img-thumbnail"
                                 style="max-height: 150px;">
                        </div>
                    {% endif %}

                    <input type="file"
                           class="form-control"
                           name="logo"
                           accept="image/*"
                           id="logo_upload">
                    <div class="form-text">
                        PNG, JPG, SVG ‚Äî 1 Mo max
                    </div>
                </div>
            </div>

            {# Actions #}
            <div class="card">
                <div class="card-body">
                    <button type="submit" class="btn btn-primary w-100 mb-2">
                        <i class="bx bx-save me-1"></i>
                        Cr√©er le client
                    </button>
                    <a href="{{ path('client_index') }}" class="btn btn-light w-100">
                        <i class="bx bx-x me-1"></i>
                        Annuler
                    </a>
                </div>
            </div>

            {# Aide #}
            <div class="card bg-light">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="bx bx-help-circle me-2"></i>
                        Aide
                    </h6>
                    <p class="card-text small text-muted mb-0">
                        Les champs marqu√©s d'un ast√©risque (*) sont obligatoires.
                    </p>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock content %}

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle manual service level
    const modeSelect = document.getElementById('service_level_mode');
    const manualContainer = document.getElementById('manual_level_container');

    if (modeSelect && manualContainer) {
        modeSelect.addEventListener('change', function() {
            manualContainer.style.display = this.value === 'manual' ? 'block' : 'none';
        });
    }

    // Preview logo
    const logoUpload = document.getElementById('logo_upload');
    if (logoUpload) {
        logoUpload.addEventListener('change', function() {
            const file = this.files[0];
            if (file && file.type.startsWith('image/')) {
                // Validation taille
                if (file.size > 1024 * 1024) {
                    alert('Le fichier est trop volumineux (max 1 Mo)');
                    this.value = '';
                }
            }
        });
    }
});
</script>
{% endblock %}
