<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <title>{% block title %}hotones{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Gestion de rentabilité des projets d'agence web" />

    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="{{ asset('favicon.svg') }}">
    <link rel="alternate icon" href="{{ asset('favicon.svg') }}">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Box Icons -->
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.0.9/css/boxicons.min.css" rel="stylesheet">

    {% block stylesheets %}
    {% endblock %}
</head>

<body>
    {% if app.user %}
    <nav class="navbar navbar-dark bg-dark fixed-top">
        <div class="navbar-brand col-md-3 col-lg-2 me-0 px-3">
            <i class="bx bx-line-chart me-2"></i>
            hotones
        </div>
        <div class="flex-grow-1 px-3">
            <form method="get" action="{{ path('global_search') }}" class="d-flex" role="search">
                <div class="input-group" style="max-width: 500px;">
                    <input type="text" name="q" class="form-control form-control-sm bg-dark text-white border-secondary"
                           placeholder="Rechercher (Ctrl+K)"
                           id="globalSearchInput"
                           autocomplete="off">
                    <button class="btn btn-sm btn-outline-secondary" type="submit">
                        <i class="bx bx-search"></i>
                    </button>
                </div>
            </form>
        </div>
        <div class="navbar-nav d-flex flex-row">
            <div class="nav-item dropdown">
                <a class="nav-link px-3 position-relative" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bx bx-bell font-size-20"></i>
                    <span class="badge bg-danger rounded-pill notification-badge position-absolute top-0 start-100 translate-middle d-none" style="font-size: 0.65rem;">
                        0
                    </span>
                </a>
                <div class="dropdown-menu dropdown-menu-end dropdown-menu-lg p-0" style="width: 350px;">
                    <div class="p-3 bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="m-0">Notifications</h6>
                            <button type="button" class="btn btn-sm btn-light" onclick="markAllNotificationsAsRead()">
                                <i class="bx bx-check-double"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-2" id="notificationDropdown" style="max-height: 400px; overflow-y: auto;">
                        <div class="text-center text-muted py-4">
                            <i class="bx bx-bell font-size-24 mb-2"></i>
                            <div>Aucune nouvelle notification</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="nav-item text-nowrap">
                <a class="nav-link px-3" href="{{ path('app_logout') }}">
                    <i class="bx bx-log-out me-1"></i> Déconnexion
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="sidebar-sticky pt-3">
                    {# Tableau de bord #}
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/' and app.request.pathinfo == '/' ? 'active' : '' }}" href="{{ path('home') }}">
                                <i class="bx bx-home me-2"></i>
                                Tableau de bord
                            </a>
                        </li>
                    </ul>

                    {# Projets & Temps #}
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>Projets & Temps</span>
                    </h6>
                    <ul class="nav flex-column mb-2">
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/projects' ? 'active' : '' }}" href="{{ path('project_index') }}">
                                <i class="bx bx-folder-open me-2"></i>
                                Projets
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/my-tasks' ? 'active' : '' }}" href="{{ path('my_tasks_index') }}">
                                <i class="bx bx-list-check me-2"></i>
                                Mes tâches
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/timesheet' ? 'active' : '' }}" href="{{ path('timesheet_index') }}">
                                <i class="bx bx-time me-2"></i>
                                Saisie temps
                            </a>
                        </li>
                        {% if is_granted('ROLE_CHEF_PROJET') %}
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/timesheet/all' ? 'active' : '' }}" href="{{ path('timesheet_all') }}">
                                <i class="bx bx-bar-chart me-2"></i>
                                Tous les temps
                            </a>
                        </li>
                        {% endif %}
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/planning' ? 'active' : '' }}" href="{{ path('planning_index') }}">
                                <i class="bx bx-calendar me-2"></i>
                                Planning
                            </a>
                        </li>
                    </ul>

                    {# Commercial #}
                    {% if is_granted('ROLE_CHEF_PROJET') %}
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>Commercial</span>
                    </h6>
                    <ul class="nav flex-column mb-2">
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/clients' ? 'active' : '' }}" href="{{ path('client_index') }}">
                                <i class="bx bx-buildings me-2"></i>
                                Clients
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/orders' ? 'active' : '' }}" href="{{ path('order_index') }}">
                                <i class="bx bx-file me-2"></i>
                                Devis
                            </a>
                        </li>
                    </ul>
                    {% endif %}

                    {# Ressources Humaines #}
                    {% if is_granted('ROLE_MANAGER') %}
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>Ressources Humaines</span>
                    </h6>
                    <ul class="nav flex-column mb-2">
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/contributors' ? 'active' : '' }}" href="{{ path('contributor_index') }}">
                                <i class="bx bx-user me-2"></i>
                                Contributeurs
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/employment-periods' ? 'active' : '' }}" href="{{ path('employment_period_index') }}">
                                <i class="bx bx-briefcase me-2"></i>
                                Contrats
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/vacation-requests' ? 'active' : '' }}" href="{{ path('vacation_request_index') }}">
                                <i class="bx bx-calendar-event me-2"></i>
                                Congés
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/hr/skills-matrix' ? 'active' : '' }}" href="{{ path('hr_skills_matrix') }}">
                                <i class="bx bx-star me-2"></i>
                                Compétences
                            </a>
                        </li>
                    </ul>
                    {% endif %}

                    {# Analytics & Rapports #}
                    {% if is_granted('ROLE_CHEF_PROJET') %}
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>Analytics & Rapports</span>
                    </h6>
                    <ul class="nav flex-column mb-2">
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/analytics' ? 'active' : '' }}" href="{{ path('analytics_dashboard') }}">
                                <i class="bx bx-line-chart me-2"></i>
                                Dashboard Analytique
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/sales-dashboard' ? 'active' : '' }}" href="{{ path('sales_dashboard_index') }}">
                                <i class="bx bx-trending-up me-2"></i>
                                Dashboard Commercial
                            </a>
                        </li>
                        {% if is_granted('ROLE_MANAGER') %}
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo == '/staffing/dashboard' ? 'active' : '' }}" href="{{ path('staffing_dashboard') }}">
                                <i class="bx bx-group me-2"></i>
                                Staffing Standard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/staffing/dashboard/annual' ? 'active' : '' }}" href="{{ path('staffing_dashboard_annual') }}">
                                <i class="bx bx-calendar-alt me-2"></i>
                                Staffing Annuel
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/hr-dashboard' ? 'active' : '' }}" href="{{ path('hr_dashboard') }}">
                                <i class="bx bx-id-card me-2"></i>
                                Dashboard RH
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/forecasting' ? 'active' : '' }}" href="{{ path('forecasting_index') }}">
                                <i class="bx bx-crystal-ball me-2"></i>
                                Prévisions
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/risks' ? 'active' : '' }}" href="{{ path('risk_projects_dashboard') }}">
                                <i class="bx bx-error-circle me-2"></i>
                                Projets à Risque
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                    {% endif %}

                    {# Mon profil #}
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>Mon profil</span>
                    </h6>
                    <ul class="nav flex-column mb-2">
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/notifications' ? 'active' : '' }}" href="{{ path('notification_index') }}">
                                <i class="bx bx-bell me-2"></i>
                                Notifications
                                {% set unreadCount = 0 %}
                                {% if unreadCount > 0 %}
                                    <span class="badge bg-danger ms-2">{{ unreadCount }}</span>
                                {% endif %}
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/profile/2fa' ? 'active' : '' }}" href="{{ path('profile_2fa_setup') }}">
                                <i class="bx bx-shield me-2"></i>
                                Configuration 2FA
                            </a>
                        </li>
                    </ul>

                    {# Administration #}
                    {% if is_granted('ROLE_ADMIN') %}
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>Administration</span>
                    </h6>
                    <ul class="nav flex-column mb-2">
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/admin/users' ? 'active' : '' }}" href="{{ path('admin_users') }}">
                                <i class="bx bx-user-circle me-2"></i>
                                Utilisateurs
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/backoffice' ? 'active' : '' }}" href="{{ path('backoffice') }}">
                                <i class="bx bx-code-alt me-2"></i>
                                Technologies
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/backoffice' ? 'active' : '' }}" href="{{ path('backoffice') }}">
                                <i class="bx bx-category me-2"></i>
                                Catégories de service
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/backoffice' ? 'active' : '' }}" href="{{ path('backoffice') }}">
                                <i class="bx bx-badge-check me-2"></i>
                                Profils métier
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/backoffice' ? 'active' : '' }}" href="{{ path('backoffice') }}">
                                <i class="bx bx-time-five me-2"></i>
                                Tâches planifiées
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ app.request.pathinfo starts with '/admin/notification-settings' ? 'active' : '' }}" href="{{ path('admin_notification_settings') }}">
                                <i class="bx bx-cog me-2"></i>
                                Paramètres notifications
                            </a>
                        </li>
                    </ul>
                    {% endif %}
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                {% for type, messages in app.flashes %}
                    {% for message in messages %}
                        <div class="alert alert-{{ type == 'error' ? 'danger' : type }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endfor %}

                {% block body %}{% endblock %}
            </main>
        </div>
    </div>
    {% else %}
        <div class="container-fluid">
            {% block login_body %}{% endblock %}
        </div>
    {% endif %}

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    {% block javascripts %}{% endblock %}
    {% if app.user %}
    <!-- Mass Actions JS -->
    <script src="{{ asset('assets/js/mass-actions.js') }}"></script>
    <!-- Form Validation JS -->
    <script src="{{ asset('assets/js/form-validation.js') }}"></script>
    <!-- Notifications JS -->
    <script src="{{ asset('assets/js/notifications.js') }}"></script>
    <script>
        // Raccourci clavier Ctrl+K ou Cmd+K pour la recherche
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    const searchInput = document.getElementById('globalSearchInput');
                    if (searchInput) {
                        searchInput.focus();
                        searchInput.select();
                    }
                }
            });
        });
    </script>
    {% endif %}
            {% block importmap %}{{ importmap('app') }}{% endblock %}
</body>
</html>
