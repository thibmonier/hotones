{% extends 'layouts/base.html.twig' %}

{% block title %}Calendrier des temps{% endblock %}

{% block content %}
    {{ component('breadcrumb', { title: 'Calendrier des temps', pagetitle: 'Temps' }) }}

    <div class="row">
        <div class="col-12">
            <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                <h4 class="mb-sm-0 font-size-18">üìÖ Calendrier de saisie des temps</h4>
                <div class="page-title-right d-flex gap-2">
                    <a href="{{ path('timesheet_export') }}" class="btn btn-outline-success">
                        <i class="bx bx-download me-1"></i> Exporter Excel
                    </a>
                    <button type="button" id="toggle-weekends-btn" class="btn btn-outline-secondary">
                        <i class="bx bx-calendar-x me-1"></i>
                        <span id="toggle-weekends-text">Afficher week-ends</span>
                    </button>
                    <a href="{{ path('timesheet_index') }}" class="btn btn-outline-secondary">
                        <i class="bx bx-grid-alt me-1"></i> Vue Grille
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de saisie/√©dition rapide -->
    <div class="modal fade" id="timesheetModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Saisir du temps</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="quick-timesheet-form">
                        <input type="hidden" id="modal-timesheet-id" name="timesheet_id">
                        <input type="hidden" id="modal-date" name="date">

                        <div class="mb-3">
                            <label for="modal-project" class="form-label">Projet <span class="text-danger">*</span></label>
                            <select id="modal-project" name="project_id" class="form-select" required>
                                <option value="">-- S√©lectionner un projet --</option>
                                {% for projectData in projectsWithTasks %}
                                    <option value="{{ projectData.project.id }}">
                                        {{ projectData.project.name }}
                                        {% if projectData.project.client %}({{ projectData.project.client.name }}){% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="modal-task" class="form-label">T√¢che</label>
                            <select id="modal-task" name="task_id" class="form-select">
                                <option value="">-- Aucune t√¢che --</option>
                            </select>
                            <small class="text-muted">S√©lectionnez d'abord un projet</small>
                        </div>

                        <div class="mb-3">
                            <label for="modal-hours" class="form-label">Heures <span class="text-danger">*</span></label>
                            <input type="number"
                                   id="modal-hours"
                                   name="hours"
                                   class="form-control"
                                   step="0.25"
                                   min="1"
                                   max="24"
                                   required
                                   placeholder="Ex: 7.5">
                            <small class="text-muted">Minimum 1h, maximum 24h</small>
                        </div>

                        <div class="mb-3">
                            <label for="modal-notes" class="form-label">Notes</label>
                            <textarea id="modal-notes"
                                      name="notes"
                                      class="form-control"
                                      rows="3"
                                      placeholder="D√©crivez bri√®vement le travail effectu√©..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-danger" id="delete-timesheet-btn" style="display: none;">
                        <i class="bx bx-trash me-1"></i> Supprimer
                    </button>
                    <button type="button" class="btn btn-primary" id="save-timesheet-btn">
                        <i class="bx bx-save me-1"></i> Enregistrer
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    {# FullCalendar CDN #}
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales/fr.global.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        const modal = new bootstrap.Modal(document.getElementById('timesheetModal'));
        const modalTitle = document.getElementById('modalTitle');
        const projectSelect = document.getElementById('modal-project');
        const taskSelect = document.getElementById('modal-task');
        const deleteBtn = document.getElementById('delete-timesheet-btn');

        // Donn√©es des projets avec t√¢ches (pour la cascade)
        const projectsData = {{ projectsWithTasks|json_encode|raw }};

        // Gestion de l'affichage des week-ends
        let weekendsHidden = localStorage.getItem('weekendsHidden') === 'true';
        const toggleWeekendsBtn = document.getElementById('toggle-weekends-btn');
        const toggleWeekendsText = document.getElementById('toggle-weekends-text');

        // Initialiser FullCalendar
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'fr',
            firstDay: 1, // Lundi
            weekends: !weekendsHidden, // Masquer week-ends par d√©faut si n√©cessaire
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,dayGridWeek'
            },
            buttonText: {
                today: "Aujourd'hui",
                month: 'Mois',
                week: 'Semaine'
            },
            events: {{ events|json_encode|raw }},

            // Clic sur une date vide : cr√©er un temps
            dateClick: function(info) {
                openModal('create', info.dateStr);
            },

            // Clic sur un √©v√©nement : √©diter
            eventClick: function(info) {
                const event = info.event;
                const props = event.extendedProps;
                openModal('edit', event.startStr, props);
            },

            // Style des √©v√©nements
            eventDidMount: function(info) {
                // Ajouter tooltip
                info.el.setAttribute('title',
                    info.event.extendedProps.projectName +
                    (info.event.extendedProps.taskName ? ' - ' + info.event.extendedProps.taskName : '') +
                    '\n' + info.event.extendedProps.hours + 'h' +
                    (info.event.extendedProps.notes ? '\n' + info.event.extendedProps.notes : '')
                );
            }
        });

        calendar.render();

        // Appliquer l'√©tat initial du bouton
        if (weekendsHidden) {
            toggleWeekendsText.textContent = 'Afficher week-ends';
        }

        // Toggle des week-ends
        if (toggleWeekendsBtn) {
            toggleWeekendsBtn.addEventListener('click', function() {
                weekendsHidden = !weekendsHidden;
                localStorage.setItem('weekendsHidden', weekendsHidden);
                calendar.setOption('weekends', !weekendsHidden);
                toggleWeekendsText.textContent = weekendsHidden ? 'Afficher week-ends' : 'Masquer week-ends';
            });
        }

        // Fonction pour ouvrir la modal
        function openModal(mode, dateStr, eventData = null) {
            const form = document.getElementById('quick-timesheet-form');
            form.reset();

            if (mode === 'create') {
                modalTitle.textContent = 'Saisir du temps - ' + new Date(dateStr).toLocaleDateString('fr-FR');
                document.getElementById('modal-timesheet-id').value = '';
                document.getElementById('modal-date').value = dateStr;
                deleteBtn.style.display = 'none';
            } else {
                modalTitle.textContent = 'Modifier le temps - ' + new Date(dateStr).toLocaleDateString('fr-FR');
                document.getElementById('modal-timesheet-id').value = eventData.timesheetId;
                document.getElementById('modal-date').value = dateStr;
                document.getElementById('modal-project').value = eventData.projectId;
                document.getElementById('modal-hours').value = eventData.hours;
                document.getElementById('modal-notes').value = eventData.notes || '';

                // Charger les t√¢ches du projet
                updateTaskOptions(eventData.projectId, eventData.taskId);

                deleteBtn.style.display = 'inline-block';
            }

            modal.show();
        }

        // Cascade projet ‚Üí t√¢ches
        projectSelect.addEventListener('change', function() {
            updateTaskOptions(this.value);
        });

        function updateTaskOptions(projectId, selectedTaskId = null) {
            taskSelect.innerHTML = '<option value="">-- Aucune t√¢che --</option>';

            if (!projectId) return;

            const project = projectsData.find(p => p.project.id == projectId);
            if (project && project.tasks) {
                project.tasks.forEach(task => {
                    const option = document.createElement('option');
                    option.value = task.id;
                    option.textContent = task.name;
                    if (selectedTaskId && task.id == selectedTaskId) {
                        option.selected = true;
                    }
                    taskSelect.appendChild(option);
                });
            }
        }

        // Sauvegarde
        document.getElementById('save-timesheet-btn').addEventListener('click', function() {
            const projectId = document.getElementById('modal-project').value;
            const taskId = document.getElementById('modal-task').value;
            const date = document.getElementById('modal-date').value;
            const hours = parseFloat(document.getElementById('modal-hours').value);
            const notes = document.getElementById('modal-notes').value;

            if (!projectId || !hours) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }

            const formData = new FormData();
            formData.append('project_id', projectId);
            formData.append('date', date);
            formData.append('hours', hours);
            formData.append('notes', notes);
            if (taskId) formData.append('task_id', taskId);

            fetch('{{ path('timesheet_save') }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    modal.hide();
                    location.reload(); // Recharger le calendrier
                } else {
                    alert('Erreur : ' + (data.error || 'Erreur inconnue'));
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur de connexion');
            });
        });

        // Suppression
        deleteBtn.addEventListener('click', function() {
            if (!confirm('Voulez-vous vraiment supprimer cette saisie de temps ?')) {
                return;
            }

            const date = document.getElementById('modal-date').value;
            const projectId = document.getElementById('modal-project').value;
            const taskId = document.getElementById('modal-task').value;

            const formData = new FormData();
            formData.append('project_id', projectId);
            formData.append('date', date);
            formData.append('hours', 0); // 0 heures = suppression
            if (taskId) formData.append('task_id', taskId);

            fetch('{{ path('timesheet_save') }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    modal.hide();
                    location.reload();
                } else {
                    alert('Erreur : ' + (data.error || 'Erreur inconnue'));
                }
            });
        });
    });
    </script>
{% endblock %}
