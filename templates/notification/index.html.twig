{% extends 'base.html.twig' %}

{% block title %}Notifications{% endblock %}

{% block body %}
{% set headerActions = [
    {label: 'Tout marquer comme lu', path: null, icon: 'bx-check-double', class: 'btn-light', id: 'mark-all-read'}
] %}
{% if is_granted('ROLE_MANAGER') %}
    {% set headerActions = headerActions|merge([{label: 'Paramètres', path: 'admin_notification_settings', icon: 'bx-cog', class: 'btn-outline-secondary'}]) %}
{% endif %}

{% include 'components/page_header.html.twig' with {
    title: 'Notifications',
    breadcrumb: [
        {label: 'Notifications', path: null}
    ],
    actions: headerActions
} %}

<div class="row">
  <div class="col-12">
    {% set activeFilterCount = (type_filter ? 1 : 0) + (status_filter ? 1 : 0) %}
    {% include 'components/filter_panel.html.twig' with {
        filters: [
            {
                type: 'select',
                name: 'type',
                label: 'Type',
                value: type_filter,
                options: [
                    {value: 'quote_won', label: 'Devis gagné'},
                    {value: 'quote_lost', label: 'Devis perdu'},
                    {value: 'quote_to_sign', label: 'Devis à signer'},
                    {value: 'project_budget_alert', label: 'Alerte budget'},
                    {value: 'timesheet_pending_validation', label: 'Temps à valider'},
                    {value: 'timesheet_reminder', label: 'Rappel saisie temps'},
                    {value: 'payment_due_alert', label: 'Échéance paiement'},
                    {value: 'kpi_threshold_exceeded', label: 'Seuil KPI dépassé'}
                ]
            },
            {
                type: 'select',
                name: 'status',
                label: 'Statut',
                value: status_filter,
                options: [
                    {value: 'unread', label: 'Non lues'},
                    {value: 'read', label: 'Lues'}
                ]
            }
        ],
        activeCount: activeFilterCount
    } %}

    <div class="card">
      <div class="card-body">

        <!-- Liste des notifications -->
        <div class="list-group">
        {% for notification in notifications %}
          <div class="list-group-item {{ notification.isRead ? '' : 'bg-light' }}" data-notification-id="{{ notification.id }}">
            <div class="d-flex w-100 align-items-start">
              <div class="me-3">
                <span class="avatar-title bg-{{ notification.type.color }} rounded-circle">
                  <i class="bx {{ notification.type.icon }}"></i>
                </span>
              </div>
              <div class="flex-grow-1">
                <div class="d-flex w-100 justify-content-between">
                  <h6 class="mb-1">{{ notification.title }}</h6>
                  <small class="text-muted">{{ notification.createdAt|date('d/m/Y H:i') }}</small>
                </div>
                <p class="mb-1">{{ notification.message }}</p>
                {% if notification.entityUrl %}
                  <a href="{{ notification.entityUrl }}" class="btn btn-sm btn-outline-primary mt-2">
                    <i class="bx bx-link-external me-1"></i> Voir
                  </a>
                {% endif %}
              </div>
              <div class="ms-2">
                {% if not notification.isRead %}
                  <button type="button" class="btn btn-sm btn-light mark-as-read" data-notification-id="{{ notification.id }}">
                    <i class="bx bx-check"></i>
                  </button>
                {% endif %}
                <form method="post" action="{{ path('notification_delete', {id: notification.id}) }}" class="d-inline" onsubmit="return confirm('Supprimer cette notification ?');">
                  <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ notification.id) }}">
                  <button type="submit" class="btn btn-sm btn-light text-danger">
                    <i class="bx bx-trash"></i>
                  </button>
                </form>
              </div>
            </div>
          </div>
        {% else %}
          <div class="text-center text-muted py-5">
            <i class="bx bx-bell font-size-24 mb-2"></i>
            <div>Aucune notification</div>
          </div>
        {% endfor %}
        </div>

        {% include 'components/pagination.html.twig' with {
            currentPage: current_page,
            totalPages: total_pages,
            itemsPerPage: 20,
            totalItems: total
        } %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
