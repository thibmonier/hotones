{% extends 'layouts/base.html.twig' %}

{% set title = 'Violations CSP (Dev)' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-title-box">
                <div class="page-title-right">
                    <button class="btn btn-primary btn-sm" onclick="location.reload()">
                        <i class="mdi mdi-refresh"></i> Actualiser
                    </button>
                </div>
                <h4 class="page-title">
                    <i class="mdi mdi-shield-alert"></i>
                    {{ title }}
                </h4>
            </div>
        </div>
    </div>

    {% if error %}
        <div class="alert alert-warning">
            <i class="mdi mdi-alert-circle-outline me-2"></i>
            {{ error }}
        </div>
    {% endif %}

    {% if violations is empty %}
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="mdi mdi-shield-check text-success" style="font-size: 48px;"></i>
                <h5 class="mt-3">Aucune violation CSP détectée</h5>
                <p class="text-muted">
                    Les violations CSP apparaîtront ici lorsqu'elles seront détectées par le navigateur.
                    <br>Consultez également la console du navigateur (F12) pour voir les violations en temps réel.
                </p>
            </div>
        </div>
    {% else %}
        <div class="card">
            <div class="card-body">
                <div class="alert alert-info mb-3">
                    <i class="mdi mdi-information me-2"></i>
                    <strong>{{ violations|length }}</strong> violation(s) détectée(s) dans les derniers logs.
                    <br><small class="text-muted">Affichage des 1000 dernières lignes du fichier de log.</small>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Directive violée</th>
                                <th>URI bloquée</th>
                                <th>Document</th>
                                <th>Source</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for violation in violations %}
                                <tr>
                                    <td class="text-nowrap">
                                        <small class="text-muted">{{ violation.timestamp }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-danger">{{ violation.violated_directive }}</span>
                                    </td>
                                    <td>
                                        <code class="text-break" style="font-size: 11px;">
                                            {{ violation.blocked_uri }}
                                        </code>
                                    </td>
                                    <td>
                                        <small class="text-muted text-break">
                                            {{ violation.document_uri }}
                                        </small>
                                    </td>
                                    <td>
                                        {% if violation.source_file %}
                                            <small class="text-muted">
                                                {{ violation.source_file }}
                                                {% if violation.line_number %}
                                                    :{{ violation.line_number }}
                                                {% endif %}
                                            </small>
                                        {% else %}
                                            <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="alert alert-warning mt-3">
            <i class="mdi mdi-lightbulb-on-outline me-2"></i>
            <strong>Conseil :</strong> Pour déboguer en temps réel, ouvrez la console du navigateur (F12) et rechargez la page.
            Les violations CSP s'affichent directement dans la console avec plus de détails.
        </div>
    {% endif %}
</div>
{% endblock %}
