{% extends 'layouts/base.html.twig' %}

{% block title %}Dashboard Analytique{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                <h4 class="mb-sm-0 font-size-18">Dashboard Analytique</h4>
                <div class="page-title-right">
                    <div class="btn-group">
                        <a href="{{ path('analytics_dashboard', {period: 'today'}) }}" class="btn btn-sm btn-outline-primary {% if selected_period == 'today' %}active{% endif %}">Aujourd'hui</a>
                        <a href="{{ path('analytics_dashboard', {period: 'week'}) }}" class="btn btn-sm btn-outline-primary {% if selected_period == 'week' %}active{% endif %}">Semaine</a>
                        <a href="{{ path('analytics_dashboard', {period: 'month'}) }}" class="btn btn-sm btn-outline-primary {% if selected_period == 'month' %}active{% endif %}">Mois</a>
                        <a href="{{ path('analytics_dashboard', {period: 'quarter'}) }}" class="btn btn-sm btn-outline-primary {% if selected_period == 'quarter' %}active{% endif %}">Trimestre</a>
                        <a href="{{ path('analytics_dashboard', {period: 'year'}) }}" class="btn btn-sm btn-outline-primary {% if selected_period == 'year' %}active{% endif %}">Année</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-info mb-0">
                <i class="bx bx-calendar me-2"></i>
                Période analysée : <strong>{{ start_date|date('d/m/Y') }}</strong> au <strong>{{ end_date|date('d/m/Y') }}</strong>
            </div>
        </div>
    </div>

    {# KPI Cards #}
    <div class="row">
        <div class="col-xl-3 col-md-6">
            <div class="card card-h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <span class="text-muted mb-3 lh-1 d-block">CA Total</span>
                            <h4 class="mb-3">
                                <span class="counter-value text-success">{{ kpis.revenue.total_revenue|number_format(0, ',', ' ') }}€</span>
                            </h4>
                        </div>
                        <div class="flex-shrink-0 text-end">
                            <div class="avatar-sm bg-soft-success rounded">
                                <span class="avatar-title bg-soft-success text-success font-size-24">
                                    <i class="bx bx-euro"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card card-h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <span class="text-muted mb-3 lh-1 d-block">Marge Brute</span>
                            <h4 class="mb-3">
                                <span class="counter-value text-{% if kpis.revenue.margin_rate >= 20 %}success{% elseif kpis.revenue.margin_rate >= 10 %}warning{% else %}danger{% endif %}">
                                    {{ kpis.revenue.total_margin|number_format(0, ',', ' ') }}€
                                </span>
                            </h4>
                            <small class="text-muted">Taux: {{ kpis.revenue.margin_rate|number_format(1) }}%</small>
                        </div>
                        <div class="flex-shrink-0 text-end">
                            <div class="avatar-sm bg-soft-primary rounded">
                                <span class="avatar-title bg-soft-primary text-primary font-size-24">
                                    <i class="bx bx-trending-up"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card card-h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <span class="text-muted mb-3 lh-1 d-block">Projets Actifs</span>
                            <h4 class="mb-3">
                                <span class="counter-value text-info">{{ kpis.projects.active }}</span>
                                <small class="text-muted">/ {{ kpis.projects.total }}</small>
                            </h4>
                            <small class="text-muted">{{ kpis.projects.completed }} terminés</small>
                        </div>
                        <div class="flex-shrink-0 text-end">
                            <div class="avatar-sm bg-soft-info rounded">
                                <span class="avatar-title bg-soft-info text-info font-size-24">
                                    <i class="bx bx-briefcase"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card card-h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <span class="text-muted mb-3 lh-1 d-block">Taux d'Occupation</span>
                            <h4 class="mb-3">
                                <span class="counter-value text-{% if kpis.time.occupation_rate >= 80 %}success{% elseif kpis.time.occupation_rate >= 60 %}warning{% else %}danger{% endif %}">
                                    {{ kpis.time.occupation_rate|number_format(0) }}%
                                </span>
                            </h4>
                            <small class="text-muted">{{ kpis.time.total_days|number_format(0) }}j / {{ (kpis.time.theoretical_capacity / 8)|number_format(0) }}j</small>
                        </div>
                        <div class="flex-shrink-0 text-end">
                            <div class="avatar-sm bg-soft-warning rounded">
                                <span class="avatar-title bg-soft-warning text-warning font-size-24">
                                    <i class="bx bx-time"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Secondary metrics #}
    <div class="row">
        <div class="col-xl-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bx bx-receipt me-2"></i>Devis</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>En attente</span>
                        <strong class="text-primary">{{ kpis.orders.pending }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Gagnés</span>
                        <strong class="text-success">{{ kpis.orders.won }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Signés</span>
                        <strong class="text-success">{{ kpis.orders.signed }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Perdus</span>
                        <strong class="text-danger">{{ kpis.orders.lost }}</strong>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <span><strong>Taux de conversion</strong></span>
                        <strong class="text-{% if kpis.orders.conversion_rate >= 70 %}success{% elseif kpis.orders.conversion_rate >= 50 %}warning{% else %}danger{% endif %}">
                            {{ kpis.orders.conversion_rate|number_format(0) }}%
                        </strong>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bx bx-pie-chart-alt me-2"></i>Répartition Projets</h5>
                </div>
                <div class="card-body">
                    <canvas id="projectTypeChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <div class="col-xl-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bx bx-group me-2"></i>Contributeurs</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <span>Total actifs</span>
                        <strong>{{ kpis.contributors.total_active }}</strong>
                    </div>
                    <h6 class="mb-2">Top 5</h6>
                    {% for contributor in kpis.contributors.top_contributors|slice(0, 5) %}
                        <div class="d-flex justify-content-between mb-1">
                            <small>{{ contributor.contributorName }}</small>
                            <small class="text-muted">{{ contributor.totalHours|number_format(0) }}h</small>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    {# Charts #}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bx bx-line-chart me-2"></i>Évolution CA & Marges (12 mois)</h5>
                </div>
                <div class="card-body">
                    <canvas id="evolutionChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>

    {# Recalculate button (admin only) #}
    {% if is_granted('ROLE_ADMIN') %}
    <div class="row mt-3">
        <div class="col-12">
            <button id="recalculate-btn" class="btn btn-warning">
                <i class="bx bx-refresh me-2"></i>Recalculer les métriques
            </button>
            <small class="text-muted ms-3">Cette opération peut prendre du temps et s'exécute en arrière-plan.</small>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Evolution Chart (Line)
const evolutionData = {{ monthly_evolution|json_encode|raw }};
const evolutionCtx = document.getElementById('evolutionChart').getContext('2d');
new Chart(evolutionCtx, {
    type: 'line',
    data: {
        labels: evolutionData.map(d => d.month_label),
        datasets: [
            {
                label: 'CA',
                data: evolutionData.map(d => d.revenue),
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.3
            },
            {
                label: 'Coût',
                data: evolutionData.map(d => d.cost),
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.3
            },
            {
                label: 'Marge',
                data: evolutionData.map(d => d.margin),
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.3
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return value.toLocaleString() + '€';
                    }
                }
            }
        }
    }
});

// Project Type Chart (Doughnut)
const projectTypeCtx = document.getElementById('projectTypeChart').getContext('2d');
new Chart(projectTypeCtx, {
    type: 'doughnut',
    data: {
        labels: ['Forfait', 'Régie'],
        datasets: [{
            data: [{{ kpis.projects.by_type.forfait }}, {{ kpis.projects.by_type.regie }}],
            backgroundColor: ['#007bff', '#ffc107']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Recalculate button handler
{% if is_granted('ROLE_ADMIN') %}
const recalculateBtn = document.getElementById('recalculate-btn');
if (recalculateBtn) {
    recalculateBtn.addEventListener('click', function() {
        if (!confirm('Recalculer les métriques pour la période actuelle ? Cette opération s\'exécute en arrière-plan.')) {
            return;
        }

        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<i class="bx bx-loader-alt bx-spin me-2"></i>Recalcul en cours...';

        fetch('{{ path('analytics_recalculate') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: new URLSearchParams({
                period: '{{ start_date.format('Y') }}',
                granularity: 'monthly'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ ' + data.message);
                setTimeout(() => location.reload(), 1000);
            } else {
                alert('❌ Erreur: ' + data.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="bx bx-refresh me-2"></i>Recalculer les métriques';
            }
        })
        .catch(error => {
            alert('❌ Erreur: ' + error.message);
            btn.disabled = false;
            btn.innerHTML = '<i class="bx bx-refresh me-2"></i>Recalculer les métriques';
        });
    });
}
{% endif %}
</script>
{% endblock %}
