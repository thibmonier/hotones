{% extends 'layouts/base.html.twig' %}

{% block title %}Facturation — {{ project.name }}{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <div class="page-title-box d-sm-flex align-items-center justify-content-between">
      <h4 class="mb-sm-0 font-size-18">Facturation — {{ project.name }}</h4>
      <div class="page-title-right">
        <a href="{{ path('project_show', {id: project.id}) }}" class="btn btn-outline-secondary">← Retour au projet</a>
      </div>
    </div>
  </div>
</div>

<div class="row mb-2">
  <div class="col-12">
    <div class="d-flex gap-3 align-items-center small text-muted">
      <span><span class="me-1 d-inline-block rounded-circle" style="width:10px;height:10px;background:var(--bs-primary);"></span> Forfait</span>
      <span><span class="me-1 d-inline-block rounded-circle" style="width:10px;height:10px;background:var(--bs-warning);"></span> Régie</span>
    </div>
  </div>
</div>

<div class="row mb-3">
  <div class="col-md-3">
    <div class="card border-0 bg-light"><div class="card-body text-center">
      <div class="text-muted">Total Forfait (échéancier)</div>
      <div class="h4">{{ totals.forfait|number_format(0, ',', ' ') }} €</div>
    </div></div>
  </div>
  <div class="col-md-3">
    <div class="card border-0 bg-light"><div class="card-body text-center">
      <div class="text-muted">Total Régie (réalisé)</div>
      <div class="h4">{{ totals.regie|number_format(0, ',', ' ') }} €</div>
    </div></div>
  </div>
  <div class="col-md-6 d-flex align-items-center">
    {% set grand = (totals.forfait + totals.regie) %}
    {% set pf = grand > 0 ? (totals.forfait / grand * 100) : 0 %}
    {% set pr = grand > 0 ? (100 - pf) : 0 %}
    <div class="w-100">
      <div class="progress" style="height: 18px;">
        <div class="progress-bar bg-primary" style="width: {{ pf }}%"></div>
        <div class="progress-bar bg-warning" style="width: {{ pr }}%"></div>
      </div>
      <div class="d-flex justify-content-between small text-muted mt-1">
        <span><span class="me-1 d-inline-block rounded-circle" style="width:8px;height:8px;background:var(--bs-primary);"></span> Forfait: {{ pf|number_format(0, ',', ' ') }}%</span>
        <span><span class="me-1 d-inline-block rounded-circle" style="width:8px;height:8px;background:var(--bs-warning);"></span> Régie: {{ pr|number_format(0, ',', ' ') }}%</span>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-centered table-nowrap mb-0">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Devis</th>
            <th>Libellé</th>
            <th class="text-end">Montant</th>
          </tr>
        </thead>
        <tbody>
          {% for e in entries %}
            <tr>
              <td>{{ e.date|date('Y-m-d') }}</td>
              <td>
                {% if e.type == 'forfait' %}
                  <span class="badge bg-primary">Forfait</span>
                {% else %}
                  <span class="badge bg-warning">Régie</span>
                {% endif %}
              </td>
              <td>{{ e.order.name ?? e.order.orderNumber }}</td>
              <td>{{ e.label }}</td>
              <td class="text-end">{{ e.amount|number_format(2, ',', ' ') }} €</td>
            </tr>
          {% else %}
            <tr><td colspan="5" class="text-center text-muted">Aucune échéance ni facturation régie trouvée.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
