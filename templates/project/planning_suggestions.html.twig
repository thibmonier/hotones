{% extends 'layouts/base.html.twig' %}

{% block title %}Suggestions de planification - {{ project.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                <h4 class="mb-sm-0">
                    <i class="mdi mdi-robot-outline me-2"></i>
                    Suggestions de planification automatique
                </h4>
                <div class="page-title-right">
                    <ol class="breadcrumb m-0">
                        <li class="breadcrumb-item"><a href="{{ path('project_index') }}">Projets</a></li>
                        <li class="breadcrumb-item"><a href="{{ path('project_show', {id: project.id}) }}">{{ project.name }}</a></li>
                        <li class="breadcrumb-item active">Suggestions de planification</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    {# Statistiques #}
    <div class="row">
        <div class="col-xl-3 col-md-6">
            <div class="card card-height-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <span class="text-muted mb-3 lh-1 d-block text-truncate">Tâches totales</span>
                            <h4 class="mb-3">
                                <span class="counter-value" data-target="{{ statistics.totalTasks }}">{{ statistics.totalTasks }}</span>
                            </h4>
                        </div>
                        <div class="flex-shrink-0">
                            <div class="avatar-sm">
                                <span class="avatar-title bg-info-subtle rounded-circle fs-3">
                                    <i class="mdi mdi-checkbox-multiple-marked text-info"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card card-height-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <span class="text-muted mb-3 lh-1 d-block text-truncate">Affectations suggérées</span>
                            <h4 class="mb-3">
                                <span class="counter-value text-success" data-target="{{ statistics.assignedTasks }}">{{ statistics.assignedTasks }}</span>
                            </h4>
                        </div>
                        <div class="flex-shrink-0">
                            <div class="avatar-sm">
                                <span class="avatar-title bg-success-subtle rounded-circle fs-3">
                                    <i class="mdi mdi-account-check text-success"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card card-height-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <span class="text-muted mb-3 lh-1 d-block text-truncate">Non affectées</span>
                            <h4 class="mb-3">
                                <span class="counter-value text-warning" data-target="{{ statistics.unassignedTasks }}">{{ statistics.unassignedTasks }}</span>
                            </h4>
                        </div>
                        <div class="flex-shrink-0">
                            <div class="avatar-sm">
                                <span class="avatar-title bg-warning-subtle rounded-circle fs-3">
                                    <i class="mdi mdi-account-question text-warning"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card card-height-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <span class="text-muted mb-3 lh-1 d-block text-truncate">Confiance moyenne</span>
                            <h4 class="mb-3">
                                <span class="counter-value" data-target="{{ (statistics.averageConfidence * 100)|round }}">{{ (statistics.averageConfidence * 100)|round }}</span>%
                            </h4>
                        </div>
                        <div class="flex-shrink-0">
                            <div class="avatar-sm">
                                <span class="avatar-title bg-primary-subtle rounded-circle fs-3">
                                    <i class="mdi mdi-chart-line text-primary"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Suggestions #}
    {% if suggestions|length > 0 %}
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="mdi mdi-lightbulb-on-outline me-2"></i>
                        Suggestions d'affectation ({{ suggestions|length }})
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="select-all" class="form-check-input"></th>
                                    <th>Tâche</th>
                                    <th>Collaborateur suggéré</th>
                                    <th>Période</th>
                                    <th>Charge</th>
                                    <th>Confiance</th>
                                    <th>Raison</th>
                                    <th>Alertes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for suggestion in suggestions %}
                                <tr>
                                    <td>
                                        <input type="checkbox" class="form-check-input suggestion-checkbox"
                                               data-task-id="{{ suggestion.task.id }}"
                                               value="{{ suggestion.task.id }}">
                                    </td>
                                    <td>
                                        <strong>{{ suggestion.task.name }}</strong><br>
                                        <small class="text-muted">{{ suggestion.task.requiredProfile.name }}</small>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0 me-2">
                                                <div class="avatar-xs">
                                                    <span class="avatar-title rounded-circle bg-primary-subtle text-primary">
                                                        {{ suggestion.contributor.firstName|slice(0, 1) }}{{ suggestion.contributor.lastName|slice(0, 1) }}
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1">
                                                {{ suggestion.contributor.fullName }}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {{ suggestion.startDate|date('d/m/Y') }}
                                        <i class="mdi mdi-arrow-right"></i>
                                        {{ suggestion.endDate|date('d/m/Y') }}
                                        <br>
                                        <small class="text-muted">{{ suggestion.startDate.diff(suggestion.endDate).days + 1 }} jours</small>
                                    </td>
                                    <td>
                                        {{ suggestion.dailyHours|number_format(1) }}h/jour
                                    </td>
                                    <td>
                                        {% set confidence_pct = (suggestion.confidence * 100)|round %}
                                        {% if confidence_pct >= 80 %}
                                            <span class="badge bg-success">{{ confidence_pct }}%</span>
                                        {% elseif confidence_pct >= 50 %}
                                            <span class="badge bg-warning">{{ confidence_pct }}%</span>
                                        {% else %}
                                            <span class="badge bg-danger">{{ confidence_pct }}%</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ suggestion.reasoning }}</small>
                                    </td>
                                    <td>
                                        {% if suggestion.warnings|length > 0 %}
                                            {% for warning in suggestion.warnings %}
                                                <span class="badge bg-warning-subtle text-warning mb-1">
                                                    <i class="mdi mdi-alert"></i> {{ warning }}
                                                </span><br>
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-3">
                        <button type="button" class="btn btn-primary" id="apply-suggestions">
                            <i class="mdi mdi-check-all me-1"></i>
                            Appliquer les suggestions sélectionnées
                        </button>
                        <a href="{{ path('planning_index', {projects: [project.id]}) }}" class="btn btn-outline-secondary">
                            <i class="mdi mdi-calendar me-1"></i>
                            Voir le planning
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {# Tâches non affectables #}
    {% if unassigned|length > 0 %}
    <div class="row">
        <div class="col-lg-12">
            <div class="card border-warning">
                <div class="card-header bg-warning-subtle">
                    <h5 class="card-title text-warning mb-0">
                        <i class="mdi mdi-alert me-2"></i>
                        Tâches sans suggestion ({{ unassigned|length }})
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Ces tâches ne peuvent pas être affectées automatiquement. Raisons possibles :</p>
                    <ul class="text-muted">
                        <li>Aucun collaborateur disponible avec le profil requis</li>
                        <li>Tous les collaborateurs sont surchargés</li>
                        <li>Profil requis non défini</li>
                        <li>Budget horaire non défini</li>
                    </ul>

                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Tâche</th>
                                    <th>Profil requis</th>
                                    <th>Estimation</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for task in unassigned %}
                                <tr>
                                    <td>{{ task.name }}</td>
                                    <td>{{ task.requiredProfile ? task.requiredProfile.name : '<span class="text-muted">Non défini</span>' }}</td>
                                    <td>{{ task.estimatedHoursRevised ?? task.estimatedHoursSold ?? 0 }}h</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Select all checkbox
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.suggestion-checkbox');

    selectAll?.addEventListener('change', function() {
        checkboxes.forEach(cb => cb.checked = this.checked);
    });

    // Apply suggestions
    document.getElementById('apply-suggestions')?.addEventListener('click', async function() {
        const selectedTasks = Array.from(checkboxes)
            .filter(cb => cb.checked)
            .map(cb => parseInt(cb.dataset.taskId));

        if (selectedTasks.length === 0) {
            alert('Veuillez sélectionner au moins une tâche');
            return;
        }

        if (!confirm(`Voulez-vous vraiment créer ${selectedTasks.length} planification(s) ?`)) {
            return;
        }

        try {
            const response = await fetch('{{ path('project_planning_suggestions_apply', {id: project.id}) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    _token: '{{ csrf_token('apply_suggestions_' ~ project.id) }}',
                    tasks: selectedTasks,
                    start_date: '{{ startDate ? startDate|date('Y-m-d') : '' }}'
                })
            });

            const data = await response.json();

            if (data.success) {
                alert(data.message);
                window.location.href = '{{ path('planning_index', {projects: [project.id]}) }}';
            } else {
                alert('Erreur: ' + data.message);
            }
        } catch (error) {
            alert('Erreur lors de l\'application des suggestions: ' + error.message);
        }
    });
});
</script>
{% endblock %}
