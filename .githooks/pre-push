#!/usr/bin/env bash
set -eo pipefail

function dc() {
  if command -v docker >/dev/null 2>&1 && docker compose version >/dev/null 2>&1; then
    docker compose "$@"
  else
    docker-compose "$@"
  fi
}

printf "[pre-push] Running test suite (excluding E2E)...\n"
# Run PHPUnit suite excluding E2E tests (require geckodriver)
if ! dc run --rm -T app ./vendor/bin/phpunit tests/Unit tests/Integration tests/Api tests/Functional; then
  printf "[pre-push] Tests failed. Aborting push.\n" >&2
  exit 1
fi

printf "[pre-push] OK\n"