/*! For license information please see dataTables.keyTable.mjs.LICENSE.txt */
import t from"jquery";import e from"datatables.net";let n=t;var i=0,s=0,o=function(t,s){if(!e.versionCheck||!e.versionCheck("1.10.8"))throw"KeyTable requires DataTables 1.10.8 or newer";this.c=n.extend(!0,{},e.defaults.keyTable,o.defaults,s),this.s={dt:new e.Api(t),dtDrawing:!1,enable:!0,focusDraw:!1,waitingForDraw:!1,lastFocus:null,namespace:".keyTable-"+i++,tabInput:null},this.dom={};var l=this.s.dt.settings()[0],a=l.keytable;if(a)return a;l.keytable=this,this._constructor()};n.extend(o.prototype,{blur:function(){this._blur()},enable:function(t){this.s.enable=t},enabled:function(){return this.s.enable},focus:function(t,e){this._focus(this.s.dt.cell(t,e))},focused:function(t){if(!this.s.lastFocus)return!1;var e=this.s.lastFocus.cell.index();return t.row===e.row&&t.column===e.column},_constructor:function(){this._tabInput();var t=this,e=this.s.dt,i=n(e.table().node()),s=this.s.namespace,o=!1;if("static"===i.css("position")&&i.css("position","relative"),n(e.table().body()).on("click"+s,"th, td",(function(n){if(!1!==t.s.enable){var i=e.cell(this);i.any()&&t._focus(i,null,!1,n)}})),n(document).on("keydown"+s,(function(e){o||t.s.dtDrawing?e.preventDefault():t._key(e)})),this.c.blurable&&n(document).on("mousedown"+s,(function(i){n(i.target).parents(".dataTables_filter, .dt-search").length&&t._blur(),n(i.target).parents().filter(e.table().container()).length||n(i.target).parents("div.DTE").length||n(i.target).parents("div.editor-datetime").length||n(i.target).parents("div.dt-datetime").length||n(i.target).parents().filter(".DTFC_Cloned").length||t._blur()})),this.c.editor){var l=this.c.editor;l.on("open.keyTableMain",(function(e,n,i){"inline"!==n&&t.s.enable&&(t.enable(!1),l.one("close"+s,(function(){t.enable(!0)})))})),this.c.editOnFocus&&e.on("key-focus"+s+" key-refocus"+s,(function(e,n,i,s){t._editor(null,s,!0)})),e.on("key"+s,(function(e,n,i,s,o){t._editor(i,o,!1)})),n(e.table().body()).on("dblclick"+s,"th, td",(function(n){!1!==t.s.enable&&(e.cell(this).any()&&(t.s.lastFocus&&this!==t.s.lastFocus.cell.node()||t._editor(null,n,!0)))})),l.on("preSubmit",(function(){o=!0})).on("preSubmitCancelled",(function(){o=!1})).on("submitComplete",(function(){o=!1}))}e.on("stateSaveParams"+s,(function(e,n,i){i.keyTable=t.s.lastFocus?t.s.lastFocus.cell.index():null})),e.on("column-visibility"+s,(function(e){t._tabInput()})),e.on("column-reorder"+s,(function(e,n,i){var s=t.s.lastFocus;if(s&&s.cell){var o=s.relative.column;s.cell[0][0].column=i.mapping.indexOf(o),s.relative.column=i.mapping.indexOf(o)}})),e.on("preDraw"+s+" scroller-will-draw"+s,(function(e){t.s.dtDrawing=!0})),e.on("draw"+s,(function(n){if((t.s.dtDrawing=!1,t._tabInput(),!t.s.focusDraw)&&t.s.lastFocus){var i=t.s.lastFocus.relative,s=e.page.info(),o=i.row;if(0===s.recordsDisplay)return;if(o<s.start||o>s.start+s.length)return;o>=s.recordsDisplay&&(o=s.recordsDisplay-1),t._focus(o,i.column,!0,n)}})),this.c.clipboard&&this._clipboard(),e.on("destroy"+s,(function(){t._blur(!0),e.off(s),n(e.table().body()).off("click"+s,"th, td").off("dblclick"+s,"th, td"),n(document).off("mousedown"+s).off("keydown"+s).off("copy"+s).off("paste"+s)}));var a=e.state.loaded();a&&a.keyTable?e.one("init",(function(){var t=e.cell(a.keyTable);t.any()&&t.focus()})):this.c.focus&&e.cell(this.c.focus).focus()},_blur:function(t){if(this.s.enable&&this.s.lastFocus){var e=this.s.lastFocus.cell;n(e.node()).removeClass(this.c.className),this.s.lastFocus=null,t||(this._updateFixedColumns(e.index().column),this._emitEvent("key-blur",[this.s.dt,e]))}},_clipboard:function(){var t=this.s.dt,e=this,i=this.s.namespace,s=this.c.clipboard;window.getSelection&&((!0===s||s.copy)&&n(document).on("copy"+i,(function(t){var n=t.originalEvent,i=window.getSelection().toString(),s=e.s.lastFocus;!i&&s&&(n.clipboardData.setData("text/plain",s.cell.render(e.c.clipboardOrthogonal)),n.preventDefault())})),(!0===s||s.paste)&&n(document).on("paste"+i,(function(n){var i,s=n.originalEvent,o=e.s.lastFocus,l=document.activeElement,a=e.c.editor;if(o&&(!l||"body"===l.nodeName.toLowerCase()))if(s.preventDefault(),window.clipboardData&&window.clipboardData.getData?i=window.clipboardData.getData("Text"):s.clipboardData&&s.clipboardData.getData&&(i=s.clipboardData.getData("text/plain")),a){var r=e._inlineOptions(o.cell.index());a.inline(r.cell,r.field,r.options).set(a.displayed()[0],i).submit()}else o.cell.data(i),t.draw(!1)})))},_columns:function(){var t=this.s.dt,e=t.columns(this.c.columns).indexes(),n=[];return t.columns(":visible").every((function(t){-1!==e.indexOf(t)&&n.push(t)})),n},_editor:function(t,e,i){if(this.s.lastFocus&&(!e||"draw"!==e.type)){var o=this,l=this.s.dt,a=this.c.editor,r=this.s.lastFocus.cell,c=this.s.namespace+"e"+s++;if(!(n("div.DTE",r.node()).length||null!==t&&(t>=0&&t<=9||11===t||12===t||t>=14&&t<=31||t>=112&&t<=123||t>=127&&t<=159))){e&&(e.stopPropagation(),13===t&&e.preventDefault());var u=function(){var t=o._inlineOptions(r.index());a.one("open"+c,(function(){a.off("cancelOpen"+c),i||n("div.DTE_Field_InputControl input, div.DTE_Field_InputControl textarea").select(),l.keys.enable(i?"tab-only":"navigation-only"),l.on("key-blur.editor",(function(t,e,n){"submit"!==a.s.editOpts.onBlur&&a.displayed()&&n.node()===r.node()&&a.submit()})),i&&n(l.table().container()).addClass("dtk-focus-alt"),a.on("preSubmitCancelled"+c,(function(){setTimeout((function(){o._focus(r,null,!1)}),50)})),a.on("submitUnsuccessful"+c,(function(){o._focus(r,null,!1)})),a.one("close"+c,(function(){l.keys.enable(!0),l.off("key-blur.editor"),a.off(c),n(l.table().container()).removeClass("dtk-focus-alt"),o.s.returnSubmit&&(o.s.returnSubmit=!1,o._emitEvent("key-return-submit",[l,r]))}))})).one("cancelOpen"+c,(function(){a.off(c)})).inline(t.cell,t.field,t.options)};13===t?(i=!0,n(document).one("keyup",(function(){u()}))):u()}}},_inlineOptions:function(t){return this.c.editorOptions?this.c.editorOptions(t):{cell:t,field:void 0,options:void 0}},_emitEvent:function(t,e){return this.s.dt.iterator("table",(function(i,s){return n(i.nTable).triggerHandler(t,e)}))},_focus:function(t,e,i,s){var o=this,l=this.s.dt,a=l.page.info(),r=this.s.lastFocus;if(s||(s=null),this.s.enable){if("number"!=typeof t){if(!t.any())return;var c=t.index();if(e=c.column,(t=l.rows({filter:"applied",order:"applied"}).indexes().indexOf(c.row))<0)return;a.serverSide&&(t+=a.start)}if(-1!==a.length&&(t<a.start||t>=a.start+a.length))return this.s.focusDraw=!0,this.s.waitingForDraw=!0,void l.one("draw",(function(){o.s.focusDraw=!1,o.s.waitingForDraw=!1,o._focus(t,e,void 0,s)})).page(Math.floor(t/a.length)).draw(!1);if(-1!==n.inArray(e,this._columns())){a.serverSide&&(t-=a.start);var u=l.cells(null,e,{search:"applied",order:"applied"}).flatten(),d=l.cell(u[t]);if(-1===this._emitEvent("key-prefocus",[this.s.dt,d,s||null]).indexOf(!1)){if(r){if(r.node===d.node())return void this._emitEvent("key-refocus",[this.s.dt,d,s||null]);this._blur()}this._removeOtherFocus();var f=n(d.node());if(f.addClass(this.c.className),this._updateFixedColumns(e),void 0===i||!0===i){this._scroll(n(window),n(document.body),f,"offset");var h=l.table().body().parentNode;if(h!==l.table().header().parentNode){var p=n(h.parentNode);this._scroll(p,p,f,"position")}}var b=l.page.info();this.s.lastFocus={cell:d,node:d.node(),relative:{row:b.start+l.rows({page:"current"}).indexes().indexOf(d.index().row),column:d.index().column}},this._emitEvent("key-focus",[this.s.dt,d,s||null]),l.state.save()}}}},_key:function(t){if(this.s.waitingForDraw)t.preventDefault();else if(!n(t.target).closest(".dte-inlineAdd").length){var e=this.s.enable;this.s.returnSubmit=("navigation-only"===e||"tab-only"===e)&&13===t.keyCode;var i=!0===e||"navigation-only"===e;if(e&&(!(0===t.keyCode||t.ctrlKey||t.metaKey||t.altKey)||t.ctrlKey&&t.altKey)){var s=this.s.lastFocus;if(s)if(this.s.dt.cell(s.node).any()){var o=this,l=this.s.dt,a=!!this.s.dt.settings()[0].oScroll.sY;if(!this.c.keys||-1!==n.inArray(t.keyCode,this.c.keys))switch(t.keyCode){case 9:t.preventDefault(),this._keyAction((function(){o._shift(t,t.shiftKey?"left":"right",!0)}));break;case 27:if(n(s.node).find("div.DTE").length)return;this.c.blurable&&!0===e&&this._blur();break;case 33:case 34:i&&!a&&(t.preventDefault(),this._keyAction((function(){l.page(33===t.keyCode?"previous":"next").draw(!1)})));break;case 35:case 36:i&&(t.preventDefault(),this._keyAction((function(){var e=l.cells({page:"current"}).indexes(),n=o._columns();o._focus(l.cell(e[35===t.keyCode?e.length-1:n[0]]),null,!0,t)})));break;case 37:i&&this._keyAction((function(){o._shift(t,"left")}));break;case 38:i&&this._keyAction((function(){o._shift(t,"up")}));break;case 39:i&&this._keyAction((function(){o._shift(t,"right")}));break;case 40:i&&this._keyAction((function(){o._shift(t,"down")}));break;case 113:if(this.c.editor){this._editor(null,t,!0);break}default:!0===e&&this._emitEvent("key",[l,t.keyCode,this.s.lastFocus.cell,t])}}else this.s.lastFocus=null}}},_keyAction:function(t){var e=this.c.editor;e&&e.mode()&&e.display()?e.submit(t):t()},_removeOtherFocus:function(){var t=this.s.dt.table().node();n.fn.dataTable.tables({api:!0}).iterator("table",(function(e){this.table().node()!==t&&this.cell.blur()}))},_scroll:function(t,e,n,i){var s=n[i](),o=n.outerHeight(),l=n.outerWidth(),a=e.scrollTop(),r=e.scrollLeft(),c=t.height(),u=t.width();"position"===i&&(s.top+=parseInt(n.closest("table").css("top"),10)),s.top<a&&s.top+o>a-5&&e.scrollTop(s.top),s.left<r&&e.scrollLeft(s.left),s.top+o>a+c&&s.top<a+c+5&&o<c&&e.scrollTop(s.top+o-c),s.left+l>r+u&&l<u&&e.scrollLeft(s.left+l-u)},_shift:function(t,e,i){var s=this.s.dt,o=s.page.info(),l=o.recordsDisplay,a=this._columns(),r=this.s.lastFocus;if(r){var c=r.cell;if(c){var u=s.rows({filter:"applied",order:"applied"}).indexes().indexOf(c.index().row);o.serverSide&&(u+=o.start);var d=s.columns(a).indexes().indexOf(c.index().column),f=u,h=a[d];"rtl"===n(s.table().node()).css("direction")&&("right"===e?e="left":"left"===e&&(e="right")),"right"===e?d>=a.length-1?(f++,h=a[0]):h=a[d+1]:"left"===e?0===d?(f--,h=a[a.length-1]):h=a[d-1]:"up"===e?f--:"down"===e&&f++,f>=0&&f<l&&-1!==n.inArray(h,a)?(t&&t.preventDefault(),this._focus(f,h,!0,t)):i&&this.c.blurable?this._blur():t&&t.preventDefault()}}},_tabInput:function(){var t=this,e=this.s.dt,i=null!==this.c.tabIndex?this.c.tabIndex:e.settings()[0].iTabIndex;if(-1!=i){if(!this.s.tabInput){var s=n('<div><input type="text" tabindex="'+i+'"/></div>').css({position:"absolute",height:1,width:0,overflow:"hidden"});s.children().on("focus",(function(n){var i=e.cell(":eq(0)",t._columns(),{page:"current"});i.any()&&t._focus(i,null,!0,n)})),this.s.tabInput=s}var o=this.s.dt.cell(":eq(0)","0:visible",{page:"current",order:"current"}).node();o&&n(o).prepend(this.s.tabInput)}},_updateFixedColumns:function(t){var e=this.s.dt,n=e.settings()[0];if(n._oFixedColumns){var i=n._oFixedColumns.s.iLeftColumns,s=n.aoColumns.length-n._oFixedColumns.s.iRightColumns;(t<i||t>=s)&&e.fixedColumns().update()}}}),o.defaults={blurable:!0,className:"focus",clipboard:!0,clipboardOrthogonal:"display",columns:"",editor:null,editOnFocus:!1,editorOptions:null,focus:null,keys:null,tabIndex:null},o.version="2.12.1",n.fn.dataTable.KeyTable=o,n.fn.DataTable.KeyTable=o,e.Api.register("cell.blur()",(function(){return this.iterator("table",(function(t){t.keytable&&t.keytable.blur()}))})),e.Api.register("cell().focus()",(function(){return this.iterator("cell",(function(t,e,n){t.keytable&&t.keytable.focus(e,n)}))})),e.Api.register("keys.disable()",(function(){return this.iterator("table",(function(t){t.keytable&&t.keytable.enable(!1)}))})),e.Api.register("keys.enable()",(function(t){return this.iterator("table",(function(e){e.keytable&&e.keytable.enable(void 0===t||t)}))})),e.Api.register("keys.enabled()",(function(t){var e=this.context;return!!e.length&&(!!e[0].keytable&&e[0].keytable.enabled())})),e.Api.register("keys.move()",(function(t){return this.iterator("table",(function(e){e.keytable&&e.keytable._shift(null,t,!1)}))})),e.ext.selector.cell.push((function(t,e,n){var i=e.focused,s=t.keytable,o=[];if(!s||void 0===i)return n;for(var l=0,a=n.length;l<a;l++)(!0===i&&s.focused(n[l])||!1===i&&!s.focused(n[l]))&&o.push(n[l]);return o})),n(document).on("preInit.dt.dtk",(function(t,i,s){if("dt"===t.namespace){var l=i.oInit.keys,a=e.defaults.keys;if(l||a){var r=n.extend({},a,l);!1!==l&&new o(i,r)}}}));export default e;