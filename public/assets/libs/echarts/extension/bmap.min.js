!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("echarts")):"function"==typeof define&&define.amd?define(["exports","echarts"],t):t((e=e||self).bmap={},e.echarts)}(this,(function(e,t){"use strict";function o(e,t){this._bmap=e,this.dimensions=["lng","lat"],this._mapOffset=[0,0],this._api=t,this._projection=new BMap.MercatorProjection}function n(e,o){return o=o||[0,0],t.util.map([0,1],(function(t){var n=o[t],i=e[t]/2,a=[],r=[];return a[t]=n-i,r[t]=n+i,a[1-t]=r[1-t]=o[1-t],Math.abs(this.dataToPoint(a)[t]-this.dataToPoint(r)[t])}),this)}var i;function a(e){for(var t in e)if(e.hasOwnProperty(t))return;return 1}o.prototype.dimensions=["lng","lat"],o.prototype.setZoom=function(e){this._zoom=e},o.prototype.setCenter=function(e){this._center=this._projection.lngLatToPoint(new BMap.Point(e[0],e[1]))},o.prototype.setMapOffset=function(e){this._mapOffset=e},o.prototype.getBMap=function(){return this._bmap},o.prototype.dataToPoint=function(e){var t=new BMap.Point(e[0],e[1]);e=this._bmap.pointToOverlayPixel(t),t=this._mapOffset;return[e.x-t[0],e.y-t[1]]},o.prototype.pointToData=function(e){var t=this._mapOffset;return[(e=this._bmap.overlayPixelToPoint({x:e[0]+t[0],y:e[1]+t[1]})).lng,e.lat]},o.prototype.getViewRect=function(){var e=this._api;return new t.graphic.BoundingRect(0,0,e.getWidth(),e.getHeight())},o.prototype.getRoamTransform=function(){return t.matrix.create()},o.prototype.prepareCustoms=function(){var e=this.getViewRect();return{coordSys:{type:"bmap",x:e.x,y:e.y,width:e.width,height:e.height},api:{coord:t.util.bind(this.dataToPoint,this),size:t.util.bind(n,this)}}},o.dimensions=o.prototype.dimensions,o.create=function(e,n){var a,r=n.getDom();e.eachComponent("bmap",(function(e){var p,s=n.getZr().painter,m=s.getViewportRoot();if("undefined"==typeof BMap)throw new Error("BMap api is not loaded");function l(e){this._root=e}if(i=i||((l.prototype=new BMap.Overlay).initialize=function(e){return e.getPanes().labelPane.appendChild(this._root),this._root},l.prototype.draw=function(){},l),a)throw new Error("Only one bmap component can exist");e.__bmap||((d=r.querySelector(".ec-extension-bmap"))&&(m.style.left="0px",m.style.top="0px",r.removeChild(d)),(d=document.createElement("div")).className="ec-extension-bmap",d.style.cssText="position:absolute;width:100%;height:100%",r.appendChild(d),(c=e.get("mapOptions"))&&delete(c=t.util.clone(c)).mapType,p=e.__bmap=new BMap.Map(d,c),d=new i(m),p.addOverlay(d),s.getViewportRootOffset=function(){return{offsetLeft:0,offsetTop:0}}),p=e.__bmap;var d,c=e.get("center");m=e.get("zoom");c&&m&&(d=p.getCenter(),s=p.getZoom(),e.centerOrZoomChanged([d.lng,d.lat],s)&&(s=new BMap.Point(c[0],c[1]),p.centerAndZoom(s,m))),(a=new o(p,n)).setMapOffset(e.__mapOffset||[0,0]),a.setZoom(m),a.setCenter(c),e.coordinateSystem=a})),e.eachSeries((function(e){"bmap"===e.get("coordinateSystem")&&(e.coordinateSystem=a)}))},t.extendComponentModel({type:"bmap",getBMap:function(){return this.__bmap},setCenterAndZoom:function(e,t){this.option.center=e,this.option.zoom=t},centerOrZoomChanged:function(e,t){var o,n=this.option;return o=e,e=n.center,!(o&&e&&o[0]===e[0]&&o[1]===e[1]&&t===n.zoom)},defaultOption:{center:[104.114129,37.550339],zoom:5,mapStyle:{},mapStyleV2:{},mapOptions:{},roam:!1}}),t.extendComponentView({type:"bmap",render:function(e,o,n){var i=!0,r=e.getBMap(),p=n.getZr().painter.getViewportRoot(),s=e.coordinateSystem,m=function(t,o){var a,r,m,l;i||(l=p.parentNode.parentNode.parentNode,a=[-parseInt(l.style.left,10)||0,-parseInt(l.style.top,10)||0],r=p.style,m=a[0]+"px",l=a[1]+"px",r.left!==m&&(r.left=m),r.top!==l&&(r.top=l),s.setMapOffset(a),e.__mapOffset=a,n.dispatchAction({type:"bmapRoam",animation:{duration:0}}))};function l(){i||n.dispatchAction({type:"bmapRoam",animation:{duration:0}})}r.removeEventListener("moving",this._oldMoveHandler),r.removeEventListener("moveend",this._oldMoveHandler),r.removeEventListener("zoomend",this._oldZoomEndHandler),r.addEventListener("moving",m),r.addEventListener("moveend",m),r.addEventListener("zoomend",l),this._oldMoveHandler=m,this._oldZoomEndHandler=l,(c=e.get("roam"))&&"scale"!==c?r.enableDragging():r.disableDragging(),c&&"move"!==c?(r.enableScrollWheelZoom(),r.enableDoubleClickZoom(),r.enablePinchToZoom()):(r.disableScrollWheelZoom(),r.disableDoubleClickZoom(),r.disablePinchToZoom());var d=e.__mapStyle,c=(m=e.get("mapStyle")||{},JSON.stringify(m));JSON.stringify(d)!==c&&(a(m)||r.setMapStyle(t.util.clone(m)),e.__mapStyle=JSON.parse(c)),d=e.__mapStyle2,m=e.get("mapStyleV2")||{},c=JSON.stringify(m),JSON.stringify(d)!==c&&(a(m)||r.setMapStyleV2(t.util.clone(m)),e.__mapStyle2=JSON.parse(c)),i=!1}}),t.registerCoordinateSystem("bmap",o),t.registerAction({type:"bmapRoam",event:"bmapRoam",update:"updateLayout"},(function(e,t){t.eachComponent("bmap",(function(e){var t=e.getBMap(),o=t.getCenter();e.setCenterAndZoom([o.lng,o.lat],t.getZoom())}))})),e.version="1.0.0",Object.defineProperty(e,"__esModule",{value:!0})}));